<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STAY NAVY - Premium Digital Planner</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
  <style>
    body { font-family: 'Pretendard', sans-serif; background-color: #f0f4f8; color: #0f172a; }
    .navy-bg { background-color: #0f172a; }
    .navy-text { color: #0f172a; }
    .navy-border { border-color: #0f172a; }
    .planner-card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
    .timer-font { font-family: 'Courier New', Courier, monospace; font-weight: bold; }
    .sidebar-active { background-color: #1e293b; border-left: 4px solid #64748b; }
    input:focus { outline: none; border-color: #0f172a; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- Firebase 설정 (기존 설정 유지) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAjMdVJpejNYvn1fjSh8d2wgs_xtNivP0w",
      authDomain: "xzxsdfgyuio.firebaseapp.com",
      projectId: "xzxsdfgyuio",
      storageBucket: "xzxsdfgyuio.firebasestorage.app",
      messagingSenderId: "196701833344",
      appId: "1:196701833344:web:132d69399ce5b2f6b0fe65"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- 앱 메인 컴포넌트 ---
    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [view, setView] = useState('dashboard');
      
      // 플래너 데이터 상태
      const [todos, setTodos] = useState([]);
      const [lectures, setLectures] = useState([]);
      const [cumulativeTime, setCumulativeTime] = useState(0); // 초 단위
      const [isTimerRunning, setIsTimerRunning] = useState(false);
      const [timeRecords, setTimeRecords] = useState({}); // { "09:00": "국어 인강" }

      // 1. 로그인 상태 감지
      useEffect(() => {
        return auth.onAuthStateChanged(u => {
          setUser(u);
          if (u) loadData(u.uid);
          setLoading(false);
        });
      }, []);

      // 2. 데이터 불러오기
      const loadData = async (uid) => {
        const doc = await db.collection('planners').doc(uid).get();
        if (doc.exists) {
          const data = doc.data();
          setTodos(data.todos || []);
          setLectures(data.lectures || []);
          setCumulativeTime(data.cumulativeTime || 0);
          setTimeRecords(data.timeRecords || {});
        }
      };

      // 3. 자동 저장 기능 (데이터 변경 시 3초 후 저장)
      useEffect(() => {
        if (!user) return;
        const saver = setTimeout(() => {
          db.collection('planners').doc(user.uid).set({
            todos, lectures, cumulativeTime, timeRecords, lastUpdated: new Date()
          }, { merge: true });
        }, 3000);
        return () => clearTimeout(saver);
      }, [todos, lectures, cumulativeTime, timeRecords]);

      // 4. 타이머 로직
      useEffect(() => {
        let interval;
        if (isTimerRunning) {
          interval = setInterval(() => setCumulativeTime(prev => prev + 1), 1000);
        }
        return () => clearInterval(interval);
      }, [isTimerRunning]);

      if (loading) return <div className="min-h-screen flex items-center justify-center">Loading STAY NAVY...</div>;

      if (!user) return <AuthView />;

      return (
        <div className="flex min-h-screen">
          {/* 사이드바 */}
          <aside className="w-64 navy-bg text-white p-6 flex flex-col fixed h-full z-10">
            <div className="mb-10">
              <h1 className="text-2xl font-bold tracking-widest text-slate-200">STAY NAVY</h1>
              <p className="text-[10px] text-slate-500 uppercase tracking-tighter">Premium Study Archive</p>
            </div>
            
            <nav className="flex-1 space-y-2 text-sm font-medium">
              <div className={`p-3 rounded-lg cursor-pointer hover:bg-slate-800 ${view === 'dashboard' && 'sidebar-active'}`} onClick={() => setView('dashboard')}>DASHBOARD</div>
              <div className={`p-3 rounded-lg cursor-pointer hover:bg-slate-800 ${view === 'todo' && 'sidebar-active'}`} onClick={() => setView('todo')}>TO-DO SETTINGS</div>
              <div className={`p-3 rounded-lg cursor-pointer hover:bg-slate-800 ${view === 'lecture' && 'sidebar-active'}`} onClick={() => setView('lecture')}>LECTURE SETUP</div>
              <div className={`p-3 rounded-lg cursor-pointer hover:bg-slate-800 ${view === 'record' && 'sidebar-active'}`} onClick={() => setView('record')}>TIME RECORD</div>
            </nav>

            <div className="mt-auto border-t border-slate-700 pt-4 text-xs text-slate-400">
              <p>{user.email}</p>
              <button onClick={() => auth.signOut()} className="mt-2 text-red-400 hover:underline">로그아웃</button>
            </div>
          </aside>

          {/* 메인 콘텐츠 */}
          <main className="ml-64 flex-1 p-10">
            {view === 'dashboard' && (
              <div className="space-y-8 animate-in fade-in duration-500">
                <header className="flex justify-between items-end">
                  <div>
                    <h2 className="text-4xl font-black navy-text tracking-tight">STAY NAVY.</h2>
                    <p className="text-slate-500 mt-1">평온을 유지하고 기록에 집중하십시오.</p>
                  </div>
                  <div className="text-right">
                    <p className="text-4xl timer-font navy-text tracking-tighter">
                      {Math.floor(cumulativeTime/3600).toString().padStart(2,'0')}:
                      {Math.floor((cumulativeTime%3600)/60).toString().padStart(2,'0')}:
                      {(cumulativeTime%60).toString().padStart(2,'0')}
                    </p>
                    <button 
                      onClick={() => setIsTimerRunning(!isTimerRunning)}
                      className={`mt-2 px-6 py-2 rounded-full text-xs font-bold transition-all ${isTimerRunning ? 'bg-red-500 text-white' : 'navy-bg text-white'}`}
                    >
                      {isTimerRunning ? 'ST / SP (정지)' : 'ST / SP (시작)'}
                    </button>
                  </div>
                </header>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                  {/* 진행 중인 인강 */}
                  <section className="planner-card p-6">
                    <h3 className="font-bold border-b pb-3 mb-4 navy-text flex items-center gap-2">
                      <span className="w-1 h-4 navy-bg"></span> CURRENT LECTURES
                    </h3>
                    <div className="space-y-3">
                      {lectures.length === 0 && <p className="text-sm text-slate-400">등록된 인강이 없습니다.</p>}
                      {lectures.map((lec, i) => (
                        <div key={i} className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                          <span className="font-medium text-sm">{lec.title}</span>
                          <span className="text-[10px] navy-bg text-white px-2 py-1 rounded">{lec.teacher} 선생님</span>
                        </div>
                      ))}
                    </div>
                  </section>

                  {/* 오늘의 할 일 요약 */}
                  <section className="planner-card p-6">
                    <h3 className="font-bold border-b pb-3 mb-4 navy-text flex items-center gap-2">
                      <span className="w-1 h-4 navy-bg"></span> TODAY'S BRIEFING
                    </h3>
                    <div className="space-y-3">
                      {todos.slice(0, 5).map((t, i) => (
                        <div key={i} className="flex items-center gap-3 text-sm">
                          <div className={`w-2 h-2 rounded-full ${t.done ? 'bg-green-400' : 'bg-slate-300'}`}></div>
                          <span className={t.done ? 'line-through text-slate-400' : ''}>{t.text}</span>
                        </div>
                      ))}
                    </div>
                  </section>
                </div>
              </div>
            )}

            {view === 'todo' && <TodoSettings todos={todos} setTodos={setTodos} />}
            {view === 'lecture' && <LectureSettings lectures={lectures} setLectures={setLectures} />}
            {view === 'record' && <TimeRecord records={timeRecords} setRecords={setTimeRecords} />}
          </main>
        </div>
      );
    }

    // --- 투두 설정 컴포넌트 ---
    const TodoSettings = ({ todos, setTodos }) => {
      const [input, setInput] = useState("");
      const add = () => { if(input) { setTodos([...todos, { text: input, done: false }]); setInput(""); } };
      return (
        <div className="max-w-2xl mx-auto planner-card p-8">
          <h3 className="text-xl font-bold mb-6 navy-text uppercase tracking-widest">To-do Management</h3>
          <div className="flex gap-2 mb-6">
            <input className="flex-1 border-b-2 navy-border p-2" value={input} onChange={e => setInput(e.target.value)} placeholder="오늘의 할 일을 입력하세요" />
            <button onClick={add} className="navy-bg text-white px-6 py-2 rounded-lg font-bold">ADD</button>
          </div>
          <div className="space-y-3">
            {todos.map((t, i) => (
              <div key={i} className="flex items-center justify-between p-4 border rounded-xl hover:bg-slate-50">
                <div className="flex items-center gap-3">
                  <input type="checkbox" checked={t.done} onChange={() => {
                    const newTodos = [...todos];
                    newTodos[i].done = !newTodos[i].done;
                    setTodos(newTodos);
                  }} className="w-5 h-5 accent-slate-900" />
                  <span className={t.done ? 'line-through text-slate-400' : 'font-medium'}>{t.text}</span>
                </div>
                <button onClick={() => setTodos(todos.filter((_, idx) => idx !== i))} className="text-red-400 text-xs">삭제</button>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // --- 인강 설정 컴포넌트 ---
    const LectureSettings = ({ lectures, setLectures }) => {
      const [title, setTitle] = useState("");
      const [teacher, setTeacher] = useState("");
      const add = () => { if(title && teacher) { setLectures([...lectures, { title, teacher }]); setTitle(""); setTeacher(""); } };
      return (
        <div className="max-w-2xl mx-auto planner-card p-8">
          <h3 className="text-xl font-bold mb-6 navy-text uppercase tracking-widest">Lecture Setup</h3>
          <div className="grid grid-cols-2 gap-4 mb-6">
            <input className="border-b-2 navy-border p-2" value={title} onChange={e => setTitle(e.target.value)} placeholder="강좌명 (ex: 뉴런)" />
            <input className="border-b-2 navy-border p-2" value={teacher} onChange={e => setTeacher(e.target.value)} placeholder="선생님 성함" />
          </div>
          <button onClick={add} className="w-full navy-bg text-white py-3 rounded-lg font-bold mb-8">인강 리스트에 추가</button>
          <div className="space-y-3">
            {lectures.map((l, i) => (
              <div key={i} className="flex justify-between items-center p-4 bg-slate-900 text-white rounded-xl shadow-lg">
                <div>
                  <p className="text-xs text-slate-400 uppercase font-bold">LECTURE {i+1}</p>
                  <p className="font-bold">{l.title}</p>
                </div>
                <div className="text-right">
                  <p className="text-sm font-medium">{l.teacher} T</p>
                  <button onClick={() => setLectures(lectures.filter((_, idx) => idx !== i))} className="text-[10px] text-slate-500 hover:text-white underline">제거</button>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // --- 타임레코드 컴포넌트 (PDF 디자인 참고) ---
    const TimeRecord = ({ records, setRecords }) => {
      const hours = Array.from({ length: 15 }, (_, i) => (i + 8).toString().padStart(2, '0') + ":00");
      return (
        <div className="max-w-4xl mx-auto planner-card p-8">
          <h3 className="text-xl font-bold mb-6 navy-text uppercase tracking-widest">Time Record</h3>
          <div className="grid grid-cols-1 gap-1">
            {hours.map(h => (
              <div key={h} className="flex border-b border-slate-100 items-center">
                <span className="w-20 text-xs font-mono text-slate-400 py-3">{h}</span>
                <input 
                  className="flex-1 p-2 text-sm text-slate-700 bg-transparent border-none"
                  value={records[h] || ""}
                  onChange={e => setRecords({...records, [h]: e.target.value})}
                  placeholder="학습 내용을 기록하세요..."
                />
              </div>
            ))}
          </div>
        </div>
      );
    };

    // --- 로그인 화면 컴포넌트 ---
    const AuthView = () => {
      const [email, setEmail] = useState("");
      const [pw, setPw] = useState("");
      const login = () => auth.signInWithEmailAndPassword(email, pw).catch(e => alert(e.message));
      const signup = () => auth.createUserWithEmailAndPassword(email, pw).catch(e => alert(e.message));
      
      return (
        <div className="min-h-screen flex flex-col items-center justify-center bg-[#0f172a] text-white p-6">
          <div className="mb-10 text-center">
            <h1 className="text-5xl font-black tracking-tighter mb-2">STAY NAVY.</h1>
            <p className="text-slate-500 text-sm tracking-[0.3em]">STUDY ARCHIVE SYSTEM</p>
          </div>
          <div className="w-full max-w-sm space-y-4">
            <input className="w-full bg-slate-800 border-none rounded-xl p-4" placeholder="EMAIL" value={email} onChange={e=>setEmail(e.target.value)} />
            <input className="w-full bg-slate-800 border-none rounded-xl p-4" type="password" placeholder="PASSWORD" value={pw} onChange={e=>setPw(e.target.value)} />
            <div className="flex gap-2 pt-4">
              <button onClick={login} className="flex-1 bg-white text-black p-4 rounded-xl font-bold hover:bg-slate-200">LOGIN</button>
              <button onClick={signup} className="flex-1 bg-slate-700 text-white p-4 rounded-xl font-bold hover:bg-slate-600">SIGN UP</button>
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
