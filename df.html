<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RootEdu - Manual Save</title>
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ğŸ”¥ íŒŒì´ì–´ë² ì´ìŠ¤ SDK (Auth + Firestore) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f3f4f6; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // ğŸ”´ ì‚¬ìš©ì ì„¤ì • (ì œê³µí•´ì£¼ì‹  í‚¤ ì ìš©ë¨)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBxugw1-vlMbFXqQZELbCazf2Tv2qmeg4Q",
            authDomain: "roh-project-3714f.firebaseapp.com",
            projectId: "roh-project-3714f",
            storageBucket: "roh-project-3714f.firebasestorage.app",
            messagingSenderId: "1060646116552",
            appId: "1:1060646116552:web:0d29a18fb9540e59c899fd",
            measurementId: "G-J57FTVWXNR"
        };

        // ğŸŸ¢ [ì„ íƒ] ìŠ¤í¬í‹°íŒŒì´ ê°œë°œì Client ID
        const SPOTIFY_CLIENT_ID = ""; // ìŠ¤í¬í‹°íŒŒì´ ê²€ìƒ‰ ê¸°ëŠ¥ ì‚¬ìš©ì‹œ ì…ë ¥

        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
            } catch (error) {
                console.error("Firebase Init Error", error);
            }
        }
        
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ==========================================

        const { useState, useEffect } = React;

        // --- ì•„ì´ì½˜ë“¤ ---
        const EditIcon = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>;
        const PlayIcon = () => <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>;
        const PauseIcon = () => <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>;
        const ResetIcon = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>;
        const GoogleIcon = () => <svg className="w-5 h-5 mr-2" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>;
        const SpotifyIcon = () => <svg className="w-5 h-5 mr-1" viewBox="0 0 24 24" fill="#1DB954"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>;
        const SearchIcon = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>;
        const SaveIcon = () => <svg className="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>;

        // --- 1. ë¡œê·¸ì¸/íšŒì›ê°€ì… ---
        const AuthView = ({ setIsLoggedIn }) => {
            const [isLoginMode, setIsLoginMode] = useState(true);
            const [name, setName] = useState("");
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");
            const [loading, setLoading] = useState(false);

            const handleGoogleLogin = async () => {
                setError("");
                setLoading(true);
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    const result = await auth.signInWithPopup(provider);
                    const user = result.user;
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (!userDoc.exists) {
                        await db.collection('users').doc(user.uid).set({
                            name: user.displayName || "Google User",
                            email: user.email,
                            step: 'empty',
                            selectedHours: [19, 20, 21],
                            studyPlan: [
                                { id: 'kor', subject: 'êµ­ì–´', color: 'purple', content: '' },
                                { id: 'math', subject: 'ìˆ˜í•™', color: 'pink', content: '' },
                                { id: 'eng', subject: 'ì˜ì–´', color: 'orange', content: '' },
                                { id: 'sci', subject: 'íƒêµ¬', color: 'blue', content: '' }
                            ]
                        });
                        alert(`${user.displayName}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`);
                    }
                } catch (err) {
                    console.error("Google Auth Error:", err);
                    if (err.code === 'auth/operation-not-supported-in-this-environment') {
                        setError("ğŸš¨ ì£¼ì˜: Google ë¡œê·¸ì¸ì€ ë³´ì•ˆìƒ íŒŒì¼(file://)ì—ì„œ ë°”ë¡œ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. VS Codeì˜ 'Live Server'ë¥¼ ì´ìš©í•˜ê±°ë‚˜, ì•„ë˜ 'ì´ë©”ì¼ ë¡œê·¸ì¸'ì„ ì´ìš©í•´ì£¼ì„¸ìš”.");
                    } else if (err.code === 'auth/popup-closed-by-user') {
                        setError("ë¡œê·¸ì¸ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.");
                    } else {
                        setError("Google ë¡œê·¸ì¸ ì˜¤ë¥˜: " + err.message);
                    }
                } finally {
                    setLoading(false);
                }
            };

            const handleEmailAuth = async () => {
                setError("");
                setLoading(true);
                try {
                    if (isLoginMode) {
                        await auth.signInWithEmailAndPassword(email, password);
                    } else {
                        if (!name) throw new Error("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        await userCredential.user.updateProfile({ displayName: name });
                        await db.collection('users').doc(userCredential.user.uid).set({
                            name: name,
                            email: email,
                            step: 'empty',
                            selectedHours: [19, 20, 21],
                            studyPlan: [
                                { id: 'kor', subject: 'êµ­ì–´', color: 'purple', content: '' },
                                { id: 'math', subject: 'ìˆ˜í•™', color: 'pink', content: '' },
                                { id: 'eng', subject: 'ì˜ì–´', color: 'orange', content: '' },
                                { id: 'sci', subject: 'íƒêµ¬', color: 'blue', content: '' }
                            ]
                        });
                        alert(`${name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`);
                    }
                } catch (err) {
                    let msg = err.message;
                    if (err.code === 'auth/email-already-in-use') msg = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
                    else if (err.code === 'auth/wrong-password') msg = "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.";
                    else if (err.code === 'auth/user-not-found') msg = "ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.";
                    else if (err.code === 'auth/weak-password') msg = "ë¹„ë°€ë²ˆí˜¸ëŠ” 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
                    else if (err.code === 'auth/operation-not-supported-in-this-environment') msg = "ë³´ì•ˆìƒ ì´ í™˜ê²½ì—ì„œëŠ” ë¡œê·¸ì¸ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¡œì»¬ ì„œë²„(http://)ë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”.";
                    setError(msg);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 fade-in px-4">
                    <div className="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md text-center">
                        <h1 className="text-3xl font-bold text-blue-600 mb-2">RootEdu</h1>
                        <p className="text-gray-400 mb-6">{isLoginMode ? "ëŒì•„ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!" : "ë‚˜ë§Œì˜ í”Œë˜ë„ˆë¥¼ ì‹œì‘í•˜ì„¸ìš”"}</p>
                        
                        <button onClick={handleGoogleLogin} className="w-full bg-white border border-gray-300 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-50 transition shadow-sm mb-6 flex items-center justify-center">
                            <GoogleIcon />
                            Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
                        </button>

                        <div className="relative mb-6">
                            <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-200"></div></div>
                            <div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-gray-500">ë˜ëŠ” ì´ë©”ì¼ë¡œ ì‹œì‘</span></div>
                        </div>

                        {!isLoginMode && (
                            <input type="text" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)" value={name} onChange={e=>setName(e.target.value)} className="w-full mb-3 p-3 border rounded-lg bg-gray-50 outline-none focus:ring-2 ring-blue-200" />
                        )}

                        <input type="email" placeholder="ì´ë©”ì¼" value={email} onChange={e=>setEmail(e.target.value)} className="w-full mb-3 p-3 border rounded-lg bg-gray-50 outline-none focus:ring-2 ring-blue-200" />
                        <input type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value={password} onChange={e=>setPassword(e.target.value)} className="w-full mb-3 p-3 border rounded-lg bg-gray-50 outline-none focus:ring-2 ring-blue-200" onKeyPress={(e) => e.key === 'Enter' && handleEmailAuth()} />
                        
                        {error && <p className="text-red-500 text-sm mb-4 break-keep">{error}</p>}

                        <button onClick={handleEmailAuth} disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition active:scale-95 shadow-md flex justify-center">
                            {loading ? "ì²˜ë¦¬ì¤‘..." : (isLoginMode ? "ë¡œê·¸ì¸" : "íšŒì›ê°€ì…")}
                        </button>

                        <div className="mt-4 text-sm text-gray-500">
                            {isLoginMode ? "ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?" : "ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?"}
                            <button onClick={() => {setIsLoginMode(!isLoginMode); setError("");}} className="text-blue-600 font-bold ml-2 underline">
                                {isLoginMode ? "íšŒì›ê°€ì…í•˜ê¸°" : "ë¡œê·¸ì¸í•˜ê¸°"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 2. ê³„íš ì—†ìŒ í™”ë©´ ---
        const EmptyPlanView = ({ setStep }) => (
            <div className="flex flex-col items-center justify-center min-h-[80vh] px-4 fade-in">
                <div className="bg-white p-10 rounded-3xl shadow-lg max-w-lg w-full text-center border border-gray-100">
                    <div className="text-6xl mb-4">ğŸ“…</div>
                    <h2 className="text-2xl font-bold text-gray-900 mb-2">ì˜¤ëŠ˜ì˜ í•™ìŠµ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤</h2>
                    <p className="text-gray-500 mb-8">ì‹œê°„ì„ ì •í•˜ê³  ìƒì„¸ ê³„íšì„ ì„¸ì›Œë³´ì„¸ìš”.<br/>ì–¸ì œë“  ì´ì–´ì„œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</p>
                    <button onClick={() => setStep('selecting')} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-700 transition shadow-lg shadow-blue-200">âœ¨ ë§ì¶¤ í•™ìŠµ ê³„íš ë§Œë“¤ê¸° â†’</button>
                </div>
            </div>
        );

        // --- 3. ì‹œê°„ ì„ íƒ í™”ë©´ ---
        const TimeSelectionView = ({ selectedHours, setSelectedHours, setStep }) => {
            const pmHours = Array.from({ length: 12 }, (_, i) => i + 12);
            const toggleHour = (hour) => {
                if (selectedHours.includes(hour)) setSelectedHours(prev => prev.filter(h => h !== hour));
                else setSelectedHours(prev => [...prev, hour].sort((a, b) => a - b));
            };
            return (
                <div className="flex justify-center py-10 px-4 fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 w-full max-w-3xl">
                        <h3 className="text-xl font-bold text-gray-900 mb-6">1. í•™ìŠµ ì‹œê°„ ì„ íƒ</h3>
                        <div className="grid grid-cols-6 gap-2 mb-8 select-none">
                            {pmHours.map(hour => {
                                const isSelected = selectedHours.includes(hour);
                                return (
                                    <div key={hour} onClick={() => toggleHour(hour)} className={`cursor-pointer rounded-xl p-4 text-center border transition-colors duration-200 ${isSelected ? 'bg-blue-500 text-white border-blue-600 shadow-md' : 'bg-gray-50 border-gray-200 hover:bg-gray-100'}`}>
                                        <div className="font-bold text-lg">{hour}ì‹œ</div>
                                    </div>
                                );
                            })}
                        </div>
                        <button onClick={() => { if(selectedHours.length === 0) return alert("ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!"); setStep('details'); }} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">ë‹¤ìŒ ë‹¨ê³„ (í•  ì¼ ì…ë ¥) â†’</button>
                    </div>
                </div>
            );
        };

        // --- 4. ìƒì„¸ ì…ë ¥ í™”ë©´ ---
        const DetailInputView = ({ studyPlan, setStudyPlan, setStep, currentEditingSubject, setCurrentEditingSubject }) => {
            const currentSubjectData = studyPlan.find(s => s.id === currentEditingSubject);
            const handleChange = (e) => {
                const newText = e.target.value;
                setStudyPlan(prevPlan => prevPlan.map(s => s.id === currentEditingSubject ? { ...s, content: newText } : s));
            };
            return (
                <div className="flex justify-center py-10 px-4 fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 w-full max-w-3xl">
                        <h3 className="text-xl font-bold text-gray-900 mb-6">2. ê³¼ëª©ë³„ í•  ì¼ ì…ë ¥</h3>
                        <div className="flex flex-col md:flex-row gap-6">
                            <div className="md:w-1/3 space-y-3">
                                {studyPlan.map(sub => (
                                    <button key={sub.id} onClick={() => setCurrentEditingSubject(sub.id)} className={`w-full text-left p-4 rounded-xl flex justify-between items-center border ${currentEditingSubject === sub.id ? `bg-${sub.color}-50 border-${sub.color}-500 ring-1 ring-${sub.color}-500` : 'bg-white border-gray-200 hover:bg-gray-50'}`}>
                                        <span className={`font-bold text-${sub.color === 'orange' ? 'yellow' : sub.color}-600`}>{sub.subject}</span>
                                        {sub.content && <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">ì‘ì„±ë¨</span>}
                                    </button>
                                ))}
                            </div>
                            <div className="md:w-2/3">
                                <textarea className="w-full h-48 p-4 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none resize-none bg-gray-50 text-gray-800 text-lg" placeholder={`ì˜ˆ: ${currentSubjectData.subject} ê¸°ì¶œë¬¸ì œ í’€ê¸°...`} value={currentSubjectData.content} onChange={handleChange}></textarea>
                            </div>
                        </div>
                        <div className="mt-8 pt-6 border-t flex justify-between">
                            <button onClick={() => setStep('selecting')} className="text-gray-500 font-medium px-4">â† ì´ì „</button>
                            <button onClick={() => setStep('dashboard')} className="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition">ê³„íší‘œ ì™„ì„±í•˜ê¸° âœ“</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 5. ë½€ëª¨ë„ë¡œ íƒ€ì´ë¨¸ ---
        const PomodoroTimer = () => {
            const [timeLeft, setTimeLeft] = useState(25 * 60);
            const [isActive, setIsActive] = useState(false);
            const [mode, setMode] = useState('focus');
            useEffect(() => {
                let interval = null;
                if (isActive && timeLeft > 0) interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
                else if (timeLeft === 0) { setIsActive(false); alert(mode === 'focus' ? "ì§‘ì¤‘ ì‹œê°„ ë! íœ´ì‹í•˜ì„¸ìš”." : "íœ´ì‹ ë! ë‹¤ì‹œ ì§‘ì¤‘í•˜ì„¸ìš”."); }
                return () => clearInterval(interval);
            }, [isActive, timeLeft, mode]);
            const changeMode = (newMode) => { setMode(newMode); setIsActive(false); setTimeLeft(newMode === 'focus' ? 25 * 60 : 5 * 60); };
            const formatTime = (seconds) => { const m = Math.floor(seconds / 60).toString().padStart(2, '0'); const s = (seconds % 60).toString().padStart(2, '0'); return `${m}:${s}`; };
            const isFocus = mode === 'focus';
            return (
                <div className={`p-6 rounded-2xl shadow-lg border transition-colors duration-500 ${isFocus ? 'bg-red-50 border-red-100' : 'bg-green-50 border-green-100'}`}>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className={`font-bold text-lg ${isFocus ? 'text-red-600' : 'text-green-600'}`}>{isFocus ? 'ğŸ”¥ ì§‘ì¤‘ ëª¨ë“œ' : 'â˜• íœ´ì‹ ëª¨ë“œ'}</h3>
                        <div className="flex gap-2 text-sm"><button onClick={() => changeMode('focus')} className={`px-3 py-1 rounded-md ${isFocus ? 'bg-red-500 text-white' : 'bg-white text-gray-500 border'}`}>25ë¶„</button><button onClick={() => changeMode('break')} className={`px-3 py-1 rounded-md ${!isFocus ? 'bg-green-500 text-white' : 'bg-white text-gray-500 border'}`}>5ë¶„</button></div>
                    </div>
                    <div className="flex flex-col items-center justify-center py-4">
                        <div className={`text-7xl font-mono font-bold tracking-tighter mb-6 ${isFocus ? 'text-red-500' : 'text-green-500'}`}>{formatTime(timeLeft)}</div>
                        <div className="flex gap-4">
                            <button onClick={() => setIsActive(!isActive)} className={`flex items-center gap-2 px-8 py-3 rounded-full text-white font-bold text-lg shadow-md hover:opacity-90 active:scale-95 transition ${isFocus ? 'bg-red-500' : 'bg-green-500'}`}>{isActive ? <><PauseIcon /> ì¼ì‹œì •ì§€</> : <><PlayIcon /> ì‹œì‘</>}</button>
                            <button onClick={() => { setIsActive(false); setTimeLeft(isFocus ? 25 * 60 : 5 * 60); }} className="p-3 rounded-full bg-white border border-gray-200 text-gray-500 hover:bg-gray-100"><ResetIcon /></button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 6. Spotify í”Œë ˆì´ì–´ ---
        const SpotifyPlayer = () => {
            const [embedUrl, setEmbedUrl] = useState("https://open.spotify.com/embed/playlist/37i9dQZF1DWWQRwui0ExPn");
            const [inputUrl, setInputUrl] = useState("");
            const [spotifyToken, setSpotifyToken] = useState(null);
            const [searchResults, setSearchResults] = useState([]);
            
            useEffect(() => {
                const hash = window.location.hash;
                if (hash && hash.includes("access_token")) {
                    const token = new URLSearchParams(hash.substring(1)).get("access_token");
                    setSpotifyToken(token);
                    window.location.hash = "";
                }
            }, []);

            const handleSpotifyLogin = () => {
                if (!SPOTIFY_CLIENT_ID) {
                    alert("ğŸ”´ ì½”ë“œë¥¼ ì—´ì–´ì„œ 'SPOTIFY_CLIENT_ID'ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!\n(ìŠ¤í¬í‹°íŒŒì´ ê°œë°œì ëŒ€ì‹œë³´ë“œì—ì„œ ë°œê¸‰ í•„ìš”)");
                    return;
                }
                const redirectUri = window.location.href.split('#')[0];
                const scope = "user-read-private user-read-email";
                const authUrl = `https://accounts.spotify.com/authorize?client_id=${SPOTIFY_CLIENT_ID}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scope)}&response_type=token&show_dialog=true`;
                window.location.href = authUrl;
            };

            const searchSpotify = async () => {
                if (!inputUrl) return;
                if (!spotifyToken) {
                    const match = inputUrl.match(/open\.spotify\.com\/(track|album|playlist)\/([a-zA-Z0-9]+)/);
                    if (match) {
                        setEmbedUrl(`https://open.spotify.com/embed/${match[1]}/${match[2]}`);
                        setInputUrl("");
                    } else {
                        alert("ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì“°ë ¤ë©´ ë¨¼ì € 'ìŠ¤í¬í‹°íŒŒì´ ë¡œê·¸ì¸'ì„ í•´ì£¼ì„¸ìš”!\në˜ëŠ” ì˜¬ë°”ë¥¸ ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                    }
                    return;
                }
                try {
                    const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(inputUrl)}&type=track,playlist&limit=5`, {
                        headers: { Authorization: `Bearer ${spotifyToken}` }
                    });
                    const data = await res.json();
                    if (data.tracks || data.playlists) {
                        const tracks = data.tracks?.items || [];
                        const playlists = data.playlists?.items || [];
                        setSearchResults([...tracks, ...playlists]);
                    }
                } catch (err) {
                    console.error("Spotify Search Error", err);
                    alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                    setSpotifyToken(null);
                }
            };

            const selectResult = (item) => {
                setEmbedUrl(`https://open.spotify.com/embed/${item.type}/${item.id}`);
                setSearchResults([]);
                setInputUrl("");
            };

            const presets = [
                { name: "ğŸ§ Lofi Beats", url: "https://open.spotify.com/embed/playlist/37i9dQZF1DWWQRwui0ExPn" },
                { name: "ğŸ¹ Focus Piano", url: "https://open.spotify.com/embed/playlist/37i9dQZF1DX4sWSpwq3LiO" },
                { name: "ğŸŒ§ï¸ Rainy Day", url: "https://open.spotify.com/embed/playlist/37i9dQZF1DX2pSTOxoPbx9" }
            ];

            return (
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-6">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-bold text-gray-900 flex items-center gap-2">
                            <SpotifyIcon /> Spotify í”Œë ˆì´ì–´
                        </h3>
                        {!spotifyToken ? (
                            <button onClick={handleSpotifyLogin} className="text-xs bg-gray-100 hover:bg-green-100 text-gray-600 hover:text-green-700 px-3 py-1 rounded-full transition border border-gray-200">
                                ğŸ”’ ë¡œê·¸ì¸ (ê²€ìƒ‰ ê¸°ëŠ¥)
                            </button>
                        ) : <span className="text-xs text-green-600 font-bold px-2">â— ì—°ê²°ë¨</span>}
                    </div>
                    <div className="w-full h-[152px] mb-4 shadow-sm rounded-xl overflow-hidden bg-black">
                        <iframe src={embedUrl} width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                    </div>
                    <div className="flex gap-2 overflow-x-auto pb-2 mb-4 scrollbar-hide">
                        {presets.map((p, idx) => (
                            <button key={idx} onClick={() => setEmbedUrl(p.url)} className="px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap transition border bg-green-50 text-green-700 border-green-200 hover:bg-green-100">{p.name}</button>
                        ))}
                    </div>
                    <div className="relative">
                        <div className="flex gap-2">
                            <input type="text" placeholder={spotifyToken ? "ë…¸ë˜, ì•¨ë²” ê²€ìƒ‰..." : "Spotify ë§í¬ ë¶™ì—¬ë„£ê¸°"} value={inputUrl} onChange={(e) => setInputUrl(e.target.value)} className="flex-1 px-4 py-2 border border-gray-200 rounded-lg text-sm outline-none focus:ring-2 ring-green-100" onKeyPress={(e) => e.key === 'Enter' && searchSpotify()} />
                            <button onClick={searchSpotify} className="px-4 py-2 bg-[#1DB954] text-white rounded-lg font-bold hover:bg-[#1ed760] transition">{spotifyToken ? <SearchIcon/> : "ë¶™ì—¬ë„£ê¸°"}</button>
                        </div>
                        {searchResults.length > 0 && (
                            <div className="absolute top-full left-0 right-0 mt-2 bg-white border border-gray-200 rounded-xl shadow-xl z-10 max-h-60 overflow-y-auto">
                                {searchResults.map(item => (
                                    <div key={item.id} onClick={() => selectResult(item)} className="p-3 hover:bg-gray-50 cursor-pointer flex items-center gap-3 border-b border-gray-100 last:border-0">
                                        <div className="flex-1 min-w-0">
                                            <p className="font-bold text-sm text-gray-800 truncate">{item.name}</p>
                                            <p className="text-xs text-gray-500 truncate">{item.artists ? item.artists[0].name : 'Playlist'}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 7. ëŒ€ì‹œë³´ë“œ ---
        const DashboardView = ({ studyPlan, selectedHours, setStep }) => {
            const activePlans = studyPlan.filter(p => p.content.trim() !== '');
            return (
                <div className="max-w-6xl mx-auto py-8 px-4 fade-in">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-6 flex flex-col md:flex-row justify-between items-center">
                        <div className="mb-4 md:mb-0">
                            <h2 className="text-2xl font-bold text-gray-900">ğŸš€ ë‚˜ë§Œì˜ í•™ìŠµ ê³„íší‘œ</h2>
                            <p className="text-gray-500 mt-1 text-sm">ì˜¤ëŠ˜ ì´ <span className="text-blue-600 font-bold text-lg mx-1">{selectedHours.length}ì‹œê°„</span>ì˜ í•™ìŠµì´ ì˜ˆì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setStep('selecting')} className="text-sm bg-gray-50 text-gray-600 border border-gray-200 px-4 py-2 rounded-lg hover:bg-gray-100 transition">ì‹œê°„ ì¬ì„¤ì •</button>
                            <button onClick={() => setStep('details')} className="text-sm bg-blue-50 text-blue-600 border border-blue-100 px-4 py-2 rounded-lg hover:bg-blue-100 transition font-bold flex items-center gap-1"><EditIcon /> ë‚´ìš© ìˆ˜ì •</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div className="lg:col-span-4 space-y-6">
                            <PomodoroTimer />
                            <SpotifyPlayer />
                        </div>
                        <div className="lg:col-span-8">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 min-h-[600px]">
                                <h3 className="font-bold text-gray-800 mb-6 flex items-center gap-2 pb-4 border-b border-gray-100"><span>ğŸ“</span> ì˜¤ëŠ˜ì˜ í•™ìŠµ ìŠ¤ì¼€ì¤„</h3>
                                <div className="space-y-6">
                                    {activePlans.length === 0 ? (
                                        <div className="text-center py-20 text-gray-400 flex flex-col items-center">
                                            <div className="text-4xl mb-4">ğŸ“­</div>
                                            <p className="mb-4">ì•„ì§ ì‘ì„±ëœ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                            <button onClick={() => setStep('details')} className="text-blue-500 underline hover:text-blue-700">ì§€ê¸ˆ ê³„íš ì„¸ìš°ê¸°</button>
                                        </div>
                                    ) : (
                                        activePlans.map((plan, index) => (
                                            <div key={plan.id} className="flex gap-4 group">
                                                <div className="w-16 text-right pt-3 font-bold text-gray-400 text-lg">{selectedHours[index % selectedHours.length] || selectedHours[0]}:00</div>
                                                <div className={`flex-1 p-5 rounded-2xl text-white shadow-lg transition transform hover:-translate-y-1 hover:shadow-xl bg-gradient-to-r ${plan.color === 'purple' ? 'from-purple-500 to-indigo-500' : plan.color === 'pink' ? 'from-pink-500 to-rose-500' : plan.color === 'orange' ? 'from-orange-400 to-red-400' : 'from-blue-500 to-cyan-500'}`}>
                                                    <div className="flex justify-between items-start mb-3"><span className="font-bold text-xs bg-white/20 px-2 py-1 rounded backdrop-blur-sm border border-white/10">{plan.subject}</span></div>
                                                    <p className="text-lg font-medium leading-relaxed whitespace-pre-wrap">{plan.content}</p>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Navbar = ({ user, handleLogout, setStep, handleManualSave, saveStatus }) => (
            <nav className="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-50">
                <div className="text-2xl font-bold text-gray-800 cursor-pointer" onClick={() => setStep('empty')}>RootEdu</div>
                <div>
                    {user ? (
                        <div className="flex items-center gap-4">
                            <button 
                                onClick={handleManualSave} 
                                disabled={saveStatus === 'saving'}
                                className={`flex items-center gap-1 px-4 py-2 rounded-lg font-bold text-sm transition shadow-sm
                                    ${saveStatus === 'saved' ? 'bg-green-50 text-green-600 border border-green-200' : 
                                      saveStatus === 'error' ? 'bg-red-50 text-red-600 border border-red-200' : 
                                      'bg-indigo-50 text-indigo-600 border border-indigo-200 hover:bg-indigo-100'}`}
                            >
                                {saveStatus === 'saving' ? (
                                    <>â³ ì €ì¥ ì¤‘...</>
                                ) : saveStatus === 'saved' ? (
                                    <>âœ… ì €ì¥ë¨</>
                                ) : (
                                    <><SaveIcon /> ì €ì¥í•˜ê¸°</>
                                )}
                            </button>
                            <div className="h-6 w-px bg-gray-200 mx-2"></div>
                            <span className="hidden md:inline text-gray-600 font-bold">{user.displayName || user.email}ë‹˜</span>
                            <button onClick={handleLogout} className="text-gray-500 hover:text-gray-900 text-sm">ë¡œê·¸ì•„ì›ƒ</button>
                        </div>
                    ) : null}
                </div>
            </nav>
        );

        // --- ë©”ì¸ ì•± ---
        function App() {
            const [user, setUser] = useState(null);
            const [isLoadingData, setIsLoadingData] = useState(true); 
            const [saveStatus, setSaveStatus] = useState('idle'); // idle, saving, saved, error
            
            const [step, setStep] = useState('empty'); 
            const [selectedHours, setSelectedHours] = useState([19, 20, 21]); 
            const [currentEditingSubject, setCurrentEditingSubject] = useState('kor');
            const [studyPlan, setStudyPlan] = useState([
                { id: 'kor', subject: 'êµ­ì–´', color: 'purple', content: '' },
                { id: 'math', subject: 'ìˆ˜í•™', color: 'pink', content: '' },
                { id: 'eng', subject: 'ì˜ì–´', color: 'orange', content: '' },
                { id: 'sci', subject: 'íƒêµ¬', color: 'blue', content: '' }
            ]);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        try {
                            const doc = await db.collection('users').doc(currentUser.uid).get();
                            if (doc.exists) {
                                const data = doc.data();
                                setStep(data.step || 'empty');
                                setSelectedHours(data.selectedHours || []);
                                if (data.studyPlan) setStudyPlan(data.studyPlan);
                            }
                        } catch (err) {
                            console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
                        } finally {
                            setIsLoadingData(false);
                        }
                    } else {
                        setUser(null);
                        setStep('empty');
                        setIsLoadingData(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            // ìˆ˜ë™ ì €ì¥ í•¸ë“¤ëŸ¬
            const handleManualSave = async () => {
                if (!user) return;
                setSaveStatus('saving');
                try {
                    await db.collection('users').doc(user.uid).set({
                        step,
                        selectedHours,
                        studyPlan,
                        lastUpdated: new Date()
                    }, { merge: true });
                    
                    setSaveStatus('saved');
                    setTimeout(() => setSaveStatus('idle'), 3000); // 3ì´ˆ í›„ ìƒíƒœ ì´ˆê¸°í™”
                } catch (err) {
                    console.error("ì €ì¥ ì‹¤íŒ¨:", err);
                    setSaveStatus('error');
                    setTimeout(() => setSaveStatus('idle'), 3000);
                }
            };

            const handleLogout = () => {
                auth.signOut();
            };

            if (!user) {
                return <AuthView setIsLoggedIn={() => {}} />;
            }

            if (isLoadingData) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50">
                        <div className="loader mb-4"></div>
                        <p className="text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-10">
                    <Navbar user={user} handleLogout={handleLogout} setStep={setStep} handleManualSave={handleManualSave} saveStatus={saveStatus} />
                    {step === 'empty' && <EmptyPlanView setStep={setStep} />}
                    {step === 'selecting' && <TimeSelectionView selectedHours={selectedHours} setSelectedHours={setSelectedHours} setStep={setStep} />}
                    {step === 'details' && <DetailInputView studyPlan={studyPlan} setStudyPlan={setStudyPlan} setStep={setStep} currentEditingSubject={currentEditingSubject} setCurrentEditingSubject={setCurrentEditingSubject} />}
                    {step === 'dashboard' && <DashboardView studyPlan={studyPlan} selectedHours={selectedHours} setStep={setStep} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
