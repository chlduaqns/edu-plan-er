<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RootEdu - Cam Study & Planner</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f3f4f6; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // ğŸ”´ ì‚¬ìš©ì ì„¤ì •
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBxugw1-vlMbFXqQZELbCazf2Tv2qmeg4Q",
            authDomain: "roh-project-3714f.firebaseapp.com",
            projectId: "roh-project-3714f",
            storageBucket: "roh-project-3714f.firebasestorage.app",
            messagingSenderId: "1060646116552",
            appId: "1:1060646116552:web:0d29a18fb9540e59c899fd",
            measurementId: "G-J57FTVWXNR"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
            } catch (error) {
                console.error("Firebase Init Error", error);
            }
        }
        
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ==========================================

        const { useState, useEffect, useRef } = React;

        // --- ì•„ì´ì½˜ë“¤ (ê¸°ì¡´ + ì‹ ê·œ ì¶”ê°€) ---
        const EditIcon = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>;
        const GoogleIcon = () => <svg className="w-5 h-5 mr-2" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>;
        const SearchIcon = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>;
        const SaveIcon = () => <svg className="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>;
        const CameraIcon = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>;
        const ResetIcon = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>;
        const PlayIcon = () => <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>;
        const PauseIcon = () => <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>;
        
        // ìº ìŠ¤í„°ë”” ì œì–´ ì•„ì´ì½˜
        const MicIcon = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>;
        const MicOffIcon = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clipRule="evenodd"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path></svg>;
        const VideoIcon = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>;
        const VideoOffIcon = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>;
        const ChatIcon = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>;
        const SendIcon = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 19l9-2-9-18-9 18 9-2zm0 0v-8"></path></svg>;


        // --- 1. ë¡œê·¸ì¸/íšŒì›ê°€ì… ---
        const AuthView = ({ setIsLoggedIn }) => {
            const [isLoginMode, setIsLoginMode] = useState(true);
            const [name, setName] = useState("");
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");
            const [loading, setLoading] = useState(false);

            const getUserDocRef = (uid) => {
                return db.collection('artifacts').doc(appId).collection('users').doc(uid).collection('data').doc('planner');
            };

            const handleGoogleLogin = async () => {
                setError("");
                setLoading(true);
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    const result = await auth.signInWithPopup(provider);
                    const user = result.user;
                    const userDocRef = getUserDocRef(user.uid);
                    const userDoc = await userDocRef.get();
                    if (!userDoc.exists) {
                        await userDocRef.set({
                            name: user.displayName || "Google User",
                            email: user.email,
                            step: 'empty',
                            selectedHours: [19, 20, 21],
                            studyPlan: [
                                { id: 'kor', subject: 'êµ­ì–´', color: 'purple', content: '' },
                                { id: 'math', subject: 'ìˆ˜í•™', color: 'pink', content: '' },
                                { id: 'eng', subject: 'ì˜ì–´', color: 'orange', content: '' },
                                { id: 'sci', subject: 'íƒêµ¬', color: 'blue', content: '' }
                            ]
                        });
                    }
                } catch (err) {
                    console.error("Auth Error:", err);
                    if (err.code === 'auth/operation-not-supported-in-this-environment') setError("ë³´ì•ˆìƒ ë¡œì»¬ ì„œë²„(http://)ì—ì„œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.");
                    else setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleEmailAuth = async () => {
                setError("");
                setLoading(true);
                try {
                    if (isLoginMode) {
                        await auth.signInWithEmailAndPassword(email, password);
                    } else {
                        if (!name) throw new Error("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        await userCredential.user.updateProfile({ displayName: name });
                        const userDocRef = getUserDocRef(userCredential.user.uid);
                        await userDocRef.set({
                            name: name,
                            email: email,
                            step: 'empty',
                            selectedHours: [19, 20, 21],
                            studyPlan: [
                                { id: 'kor', subject: 'êµ­ì–´', color: 'purple', content: '' },
                                { id: 'math', subject: 'ìˆ˜í•™', color: 'pink', content: '' },
                                { id: 'eng', subject: 'ì˜ì–´', color: 'orange', content: '' },
                                { id: 'sci', subject: 'íƒêµ¬', color: 'blue', content: '' }
                            ]
                        });
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 fade-in px-4">
                    <div className="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md text-center">
                        <h1 className="text-3xl font-bold text-blue-600 mb-2">RootEdu</h1>
                        <p className="text-gray-400 mb-6">{isLoginMode ? "ëŒì•„ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!" : "ë‚˜ë§Œì˜ í”Œë˜ë„ˆë¥¼ ì‹œì‘í•˜ì„¸ìš”"}</p>
                        <button onClick={handleGoogleLogin} className="w-full bg-white border border-gray-300 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-50 mb-6 flex items-center justify-center"><GoogleIcon />Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°</button>
                        <div className="relative mb-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-200"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-gray-500">ë˜ëŠ” ì´ë©”ì¼ë¡œ ì‹œì‘</span></div></div>
                        {!isLoginMode && <input type="text" placeholder="ì´ë¦„" value={name} onChange={e=>setName(e.target.value)} className="w-full mb-3 p-3 border rounded-lg bg-gray-50 outline-none focus:ring-2 ring-blue-200" />}
                        <input type="email" placeholder="ì´ë©”ì¼" value={email} onChange={e=>setEmail(e.target.value)} className="w-full mb-3 p-3 border rounded-lg bg-gray-50 outline-none focus:ring-2 ring-blue-200" />
                        <input type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value={password} onChange={e=>setPassword(e.target.value)} className="w-full mb-3 p-3 border rounded-lg bg-gray-50 outline-none focus:ring-2 ring-blue-200" onKeyPress={(e) => e.key === 'Enter' && handleEmailAuth()} />
                        {error && <p className="text-red-500 text-sm mb-4 break-keep">{error}</p>}
                        <button onClick={handleEmailAuth} disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition active:scale-95 shadow-md flex justify-center">{loading ? "ì²˜ë¦¬ì¤‘..." : (isLoginMode ? "ë¡œê·¸ì¸" : "íšŒì›ê°€ì…")}</button>
                        <div className="mt-4 text-sm text-gray-500">{isLoginMode ? "ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?" : "ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?"} <button onClick={() => {setIsLoginMode(!isLoginMode); setError("");}} className="text-blue-600 font-bold ml-2 underline">{isLoginMode ? "íšŒì›ê°€ì…í•˜ê¸°" : "ë¡œê·¸ì¸í•˜ê¸°"}</button></div>
                    </div>
                </div>
            );
        };

        // --- 2~4. ê¸°ë³¸ ë·°ë“¤ ---
        const EmptyPlanView = ({ setStep }) => (
            <div className="flex flex-col items-center justify-center min-h-[80vh] px-4 fade-in">
                <div className="bg-white p-10 rounded-3xl shadow-lg max-w-lg w-full text-center border border-gray-100">
                    <div className="text-6xl mb-4">ğŸ“…</div>
                    <h2 className="text-2xl font-bold text-gray-900 mb-2">ì˜¤ëŠ˜ì˜ í•™ìŠµ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤</h2>
                    <p className="text-gray-500 mb-8">ì‹œê°„ì„ ì •í•˜ê³  ìƒì„¸ ê³„íšì„ ì„¸ì›Œë³´ì„¸ìš”.</p>
                    <button onClick={() => setStep('selecting')} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-700 transition shadow-lg shadow-blue-200">âœ¨ ë§ì¶¤ í•™ìŠµ ê³„íš ë§Œë“¤ê¸° â†’</button>
                </div>
            </div>
        );

        const TimeSelectionView = ({ selectedHours, setSelectedHours, setStep }) => {
            const pmHours = Array.from({ length: 12 }, (_, i) => i + 12);
            const toggleHour = (hour) => {
                if (selectedHours.includes(hour)) setSelectedHours(prev => prev.filter(h => h !== hour));
                else setSelectedHours(prev => [...prev, hour].sort((a, b) => a - b));
            };
            return (
                <div className="flex justify-center py-10 px-4 fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 w-full max-w-3xl">
                        <h3 className="text-xl font-bold text-gray-900 mb-6">1. í•™ìŠµ ì‹œê°„ ì„ íƒ</h3>
                        <div className="grid grid-cols-6 gap-2 mb-8 select-none">
                            {pmHours.map(hour => (
                                <div key={hour} onClick={() => toggleHour(hour)} className={`cursor-pointer rounded-xl p-4 text-center border transition-colors duration-200 ${selectedHours.includes(hour) ? 'bg-blue-500 text-white border-blue-600 shadow-md' : 'bg-gray-50 border-gray-200 hover:bg-gray-100'}`}>
                                    <div className="font-bold text-lg">{hour}ì‹œ</div>
                                </div>
                            ))}
                        </div>
                        <button onClick={() => { if(selectedHours.length === 0) return alert("ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!"); setStep('details'); }} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">ë‹¤ìŒ ë‹¨ê³„ (í•  ì¼ ì…ë ¥) â†’</button>
                    </div>
                </div>
            );
        };

        const DetailInputView = ({ studyPlan, setStudyPlan, setStep, currentEditingSubject, setCurrentEditingSubject }) => {
            const currentSubjectData = studyPlan.find(s => s.id === currentEditingSubject);
            const handleChange = (e) => setStudyPlan(prevPlan => prevPlan.map(s => s.id === currentEditingSubject ? { ...s, content: e.target.value } : s));
            return (
                <div className="flex justify-center py-10 px-4 fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 w-full max-w-3xl">
                        <h3 className="text-xl font-bold text-gray-900 mb-6">2. ê³¼ëª©ë³„ í•  ì¼ ì…ë ¥</h3>
                        <div className="flex flex-col md:flex-row gap-6">
                            <div className="md:w-1/3 space-y-3">
                                {studyPlan.map(sub => (
                                    <button key={sub.id} onClick={() => setCurrentEditingSubject(sub.id)} className={`w-full text-left p-4 rounded-xl flex justify-between items-center border ${currentEditingSubject === sub.id ? `bg-${sub.color}-50 border-${sub.color}-500 ring-1 ring-${sub.color}-500` : 'bg-white border-gray-200 hover:bg-gray-50'}`}>
                                        <span className={`font-bold text-${sub.color === 'orange' ? 'yellow' : sub.color}-600`}>{sub.subject}</span>
                                        {sub.content && <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">ì‘ì„±ë¨</span>}
                                    </button>
                                ))}
                            </div>
                            <div className="md:w-2/3">
                                <textarea className="w-full h-48 p-4 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none resize-none bg-gray-50 text-gray-800 text-lg" placeholder={`ì˜ˆ: ${currentSubjectData.subject} ê¸°ì¶œë¬¸ì œ í’€ê¸°...`} value={currentSubjectData.content} onChange={handleChange}></textarea>
                            </div>
                        </div>
                        <div className="mt-8 pt-6 border-t flex justify-between">
                            <button onClick={() => setStep('selecting')} className="text-gray-500 font-medium px-4">â† ì´ì „</button>
                            <button onClick={() => setStep('dashboard')} className="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition">ê³„íší‘œ ì™„ì„±í•˜ê¸° âœ“</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 5. ë½€ëª¨ë„ë¡œ íƒ€ì´ë¨¸ ---
        const PomodoroTimer = () => {
            const [timeLeft, setTimeLeft] = useState(25 * 60);
            const [isActive, setIsActive] = useState(false);
            const [mode, setMode] = useState('focus');
            useEffect(() => {
                let interval = null;
                if (isActive && timeLeft > 0) interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
                else if (timeLeft === 0) { setIsActive(false); alert(mode === 'focus' ? "ì§‘ì¤‘ ì‹œê°„ ë! íœ´ì‹í•˜ì„¸ìš”." : "íœ´ì‹ ë! ë‹¤ì‹œ ì§‘ì¤‘í•˜ì„¸ìš”."); }
                return () => clearInterval(interval);
            }, [isActive, timeLeft, mode]);
            const changeMode = (newMode) => { setMode(newMode); setIsActive(false); setTimeLeft(newMode === 'focus' ? 25 * 60 : 5 * 60); };
            const formatTime = (seconds) => { const m = Math.floor(seconds / 60).toString().padStart(2, '0'); const s = (seconds % 60).toString().padStart(2, '0'); return `${m}:${s}`; };
            const isFocus = mode === 'focus';
            return (
                <div className={`p-6 rounded-2xl shadow-lg border transition-colors duration-500 ${isFocus ? 'bg-red-50 border-red-100' : 'bg-green-50 border-green-100'}`}>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className={`font-bold text-lg ${isFocus ? 'text-red-600' : 'text-green-600'}`}>{isFocus ? 'ğŸ”¥ ì§‘ì¤‘ ëª¨ë“œ' : 'â˜• íœ´ì‹ ëª¨ë“œ'}</h3>
                        <div className="flex gap-2 text-sm"><button onClick={() => changeMode('focus')} className={`px-3 py-1 rounded-md ${isFocus ? 'bg-red-500 text-white' : 'bg-white text-gray-500 border'}`}>25ë¶„</button><button onClick={() => changeMode('break')} className={`px-3 py-1 rounded-md ${!isFocus ? 'bg-green-500 text-white' : 'bg-white text-gray-500 border'}`}>5ë¶„</button></div>
                    </div>
                    <div className="flex flex-col items-center justify-center py-4">
                        <div className={`text-7xl font-mono font-bold tracking-tighter mb-6 ${isFocus ? 'text-red-500' : 'text-green-500'}`}>{formatTime(timeLeft)}</div>
                        <div className="flex gap-4">
                            <button onClick={() => setIsActive(!isActive)} className={`flex items-center gap-2 px-8 py-3 rounded-full text-white font-bold text-lg shadow-md hover:opacity-90 active:scale-95 transition ${isFocus ? 'bg-red-500' : 'bg-green-500'}`}>{isActive ? <><PauseIcon /> ì¼ì‹œì •ì§€</> : <><PlayIcon /> ì‹œì‘</>}</button>
                            <button onClick={() => { setIsActive(false); setTimeLeft(isFocus ? 25 * 60 : 5 * 60); }} className="p-3 rounded-full bg-white border border-gray-200 text-gray-500 hover:bg-gray-100"><ResetIcon /></button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 6. Music Player ---
        const MusicPlayer = () => {
            const [videoId, setVideoId] = useState("jfKfPfyJRdk");
            const [inputUrl, setInputUrl] = useState("");
            const presets = [ { name: "ğŸ§ Lofi Girl", id: "jfKfPfyJRdk" }, { name: "â˜• Cafe Jazz", id: "5qap5aO4i9A" }, { name: "ğŸŒ§ï¸ ë¹—ì†Œë¦¬", id: "mPZkdNFkNps" }, { name: "ğŸ¹ í”¼ì•„ë…¸", id: "7J_M3p_z0c0" } ];
            const extractVideoId = (url) => { if (!url) return ""; const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/; const match = url.match(regExp); return (match && match[2].length === 11) ? match[2] : url; };
            const handlePlay = () => { const id = extractVideoId(inputUrl); if (id) { setVideoId(id); setInputUrl(""); } else alert("ì˜¬ë°”ë¥¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); };
            const handleSearch = () => { if (!inputUrl) return alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!"); window.open(`https://www.youtube.com/results?search_query=study+music+${encodeURIComponent(inputUrl)}`, '_blank'); };

            return (
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-6">
                    <h3 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">ğŸµ í•™ìŠµ BGM í”Œë ˆì´ì–´</h3>
                    <div className="aspect-video w-full bg-black rounded-xl overflow-hidden mb-4 shadow-inner">
                        <iframe width="100%" height="100%" src={`https://www.youtube.com/embed/${videoId}?rel=0&playsinline=1&modestbranding=1`} title="YouTube video player" frameBorder="0" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen></iframe>
                    </div>
                    <div className="flex gap-2 overflow-x-auto pb-2 mb-4 scrollbar-hide">
                        {presets.map(p => ( <button key={p.id} onClick={() => setVideoId(p.id)} className="px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap transition border bg-gray-50 text-gray-600 hover:bg-gray-100">{p.name}</button> ))}
                    </div>
                    <div className="flex gap-2">
                        <input type="text" placeholder="ê²€ìƒ‰ì–´ ë˜ëŠ” ìœ íŠœë¸Œ ì£¼ì†Œ" value={inputUrl} onChange={(e) => setInputUrl(e.target.value)} className="flex-1 px-4 py-2 border border-gray-200 rounded-lg text-sm outline-none focus:ring-2 ring-indigo-100" onKeyPress={(e) => e.key === 'Enter' && handlePlay()} />
                        <button onClick={handleSearch} className="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition"><SearchIcon /></button>
                        <button onClick={handlePlay} className="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition">ë¡œë”©</button>
                    </div>
                </div>
            );
        };

        // --- 7. [UPDATED] Cam Study (With Chat & Controls) ---
        const CamStudyView = ({ user, onClose }) => {
            const [localStream, setLocalStream] = useState(null);
            const [remoteUsers, setRemoteUsers] = useState({});
            const [myPeerId, setMyPeerId] = useState(null);
            const [dbUsers, setDbUsers] = useState({}); 
            const [isMicOn, setIsMicOn] = useState(true); // ë§ˆì´í¬ ìƒíƒœ
            const [isCamOn, setIsCamOn] = useState(true); // ìº  ìƒíƒœ
            const [showChat, setShowChat] = useState(false); // ì±„íŒ…ì°½ í‘œì‹œ ì—¬ë¶€
            const [messages, setMessages] = useState([]); // ì±„íŒ… ë©”ì‹œì§€ ëª©ë¡
            const [inputMsg, setInputMsg] = useState(""); // ì…ë ¥ ë©”ì‹œì§€
            
            const peerRef = useRef(null);
            const localVideoRef = useRef(null);
            const userDocRef = useRef(null);
            const chatEndRef = useRef(null); // ì±„íŒ… ìŠ¤í¬ë¡¤ìš©

            // 1. PeerJS ë° ë¯¸ë””ì–´ ì´ˆê¸°í™”
            useEffect(() => {
                const initPeer = async () => {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                        setLocalStream(stream);
                        if (localVideoRef.current) localVideoRef.current.srcObject = stream;

                        const peer = new Peer();
                        peerRef.current = peer;

                        peer.on('open', async (id) => {
                            setMyPeerId(id);
                            userDocRef.current = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('cam_study').doc(user.uid);
                            await userDocRef.current.set({
                                peerId: id,
                                name: user.displayName || user.email,
                                lastActive: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            window.addEventListener('beforeunload', () => userDocRef.current.delete());
                        });

                        peer.on('call', (call) => {
                            call.answer(stream);
                            setupCallEvent(call);
                        });

                    } catch (err) {
                        console.error("Cam Study Error:", err);
                        alert("ì¹´ë©”ë¼/ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
                        onClose();
                    }
                };

                initPeer();

                return () => {
                    if(peerRef.current) peerRef.current.destroy();
                    if(localStream) localStream.getTracks().forEach(track => track.stop());
                    if(userDocRef.current) userDocRef.current.delete();
                };
            }, []);

            // 2. ì±„íŒ… ë¦¬ìŠ¤ë„ˆ (Firestore)
            useEffect(() => {
                const unsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('chat_messages')
                    .orderBy('createdAt', 'asc')
                    .limit(50)
                    .onSnapshot(snapshot => {
                        const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setMessages(msgs);
                        if(chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
                    });
                return () => unsubscribe();
            }, []);

            // ìë™ ìŠ¤í¬ë¡¤
            useEffect(() => {
                if(showChat && chatEndRef.current) chatEndRef.current.scrollIntoView();
            }, [showChat, messages]);

            const setupCallEvent = (call, userName = "ì¹œêµ¬") => {
                call.on('stream', (remoteStream) => {
                    setRemoteUsers(prev => ({ ...prev, [call.peer]: { stream: remoteStream, name: userName } }));
                });
                call.on('close', () => {
                    setRemoteUsers(prev => { const newState = { ...prev }; delete newState[call.peer]; return newState; });
                });
            };

            // DB ìœ ì € ê°ì§€ ë° ì—°ê²°
            useEffect(() => {
                if (!myPeerId || !localStream) return;
                const unsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('cam_study')
                    .onSnapshot(snapshot => {
                        const currentDbUsers = {};
                        snapshot.docs.forEach(doc => {
                            const data = doc.data();
                            currentDbUsers[data.peerId] = data.name;
                            if (doc.id !== user.uid && data.peerId) {
                                setRemoteUsers(prev => {
                                    if (prev[data.peerId]) return prev;
                                    if (myPeerId > data.peerId) {
                                        const call = peerRef.current.call(data.peerId, localStream);
                                        if (call) setupCallEvent(call, data.name);
                                    }
                                    return prev;
                                });
                            }
                        });
                        setDbUsers(currentDbUsers);
                        // ë‚˜ê°„ ìœ ì € ì •ë¦¬
                        const activePeerIds = snapshot.docs.map(d => d.data().peerId);
                        setRemoteUsers(prev => {
                            const next = { ...prev };
                            Object.keys(next).forEach(pId => { if (!activePeerIds.includes(pId)) delete next[pId]; });
                            return next;
                        });
                    });
                return () => unsubscribe();
            }, [myPeerId, localStream]);

            // --- ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ---
            
            // ë§ˆì´í¬ í† ê¸€
            const toggleMic = () => {
                if(localStream) {
                    const audioTrack = localStream.getAudioTracks()[0];
                    if(audioTrack) {
                        audioTrack.enabled = !audioTrack.enabled;
                        setIsMicOn(audioTrack.enabled);
                    }
                }
            };

            // ìº  í† ê¸€
            const toggleCam = () => {
                if(localStream) {
                    const videoTrack = localStream.getVideoTracks()[0];
                    if(videoTrack) {
                        videoTrack.enabled = !videoTrack.enabled;
                        setIsCamOn(videoTrack.enabled);
                    }
                }
            };

            // ì±„íŒ… ì „ì†¡
            const sendMessage = async () => {
                if(!inputMsg.trim()) return;
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('chat_messages').add({
                        text: inputMsg,
                        sender: user.displayName || "ìµëª…",
                        uid: user.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setInputMsg("");
                } catch(err) {
                    console.error("Chat Error", err);
                }
            };

            const RemoteVideo = ({ stream, name, peerId }) => {
                const ref = useRef();
                const displayName = dbUsers[peerId] || name || "ì¹œêµ¬";
                useEffect(() => { if (ref.current) ref.current.srcObject = stream; }, [stream]);
                return (
                    <div className="aspect-video bg-gray-800 rounded-xl overflow-hidden relative border border-gray-700 shadow-lg group">
                        <video ref={ref} autoPlay playsInline className="w-full h-full object-cover"></video>
                        <div className="absolute bottom-3 left-3 bg-black/60 text-white text-xs px-2 py-1 rounded">{displayName}</div>
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 z-50 bg-gray-900 flex flex-col">
                    {/* ìƒë‹¨ í—¤ë” */}
                    <div className="flex justify-between items-center px-6 py-4 bg-gray-800 border-b border-gray-700">
                        <h2 className="text-xl font-bold text-white flex items-center gap-2">ğŸ“· RootEdu Cam Study</h2>
                        <div className="text-gray-400 text-sm">{Object.keys(remoteUsers).length + 1}ëª… ì ‘ì† ì¤‘</div>
                    </div>

                    {/* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ (ë¹„ë””ì˜¤ + ì±„íŒ…) */}
                    <div className="flex-1 flex overflow-hidden">
                        
                        {/* ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œ */}
                        <div className={`flex-1 p-4 overflow-y-auto transition-all duration-300 ${showChat ? 'pr-0' : ''}`}>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-w-7xl mx-auto">
                                {/* ë‚´ í™”ë©´ */}
                                <div className="aspect-video bg-black rounded-xl overflow-hidden relative border-2 border-indigo-500 shadow-xl">
                                    <video ref={localVideoRef} autoPlay playsInline muted className={`w-full h-full object-cover transform scale-x-[-1] ${!isCamOn ? 'hidden' : ''}`}></video>
                                    {!isCamOn && <div className="absolute inset-0 flex items-center justify-center text-gray-500 flex-col"><div className="text-4xl mb-2">ğŸ“·</div><div>ì¹´ë©”ë¼ êº¼ì§</div></div>}
                                    <div className="absolute bottom-3 left-3 bg-indigo-600 text-white text-xs px-2 py-1 rounded font-bold flex items-center gap-1">
                                        ë‚˜ ({user.displayName}) {!isMicOn && 'ğŸ”‡'}
                                    </div>
                                </div>

                                {/* ì¹œêµ¬ë“¤ í™”ë©´ */}
                                {Object.entries(remoteUsers).map(([peerId, u]) => (
                                    <RemoteVideo key={peerId} peerId={peerId} stream={u.stream} name={u.name} />
                                ))}
                            </div>
                        </div>

                        {/* ì±„íŒ… ì‚¬ì´ë“œë°” */}
                        {showChat && (
                            <div className="w-80 bg-white border-l border-gray-200 flex flex-col fade-in">
                                <div className="p-4 border-b bg-gray-50 font-bold text-gray-700 flex justify-between items-center">
                                    <span>ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ…</span>
                                    <button onClick={()=>setShowChat(false)} className="text-gray-400 hover:text-gray-600">âœ•</button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                                    {messages.map(msg => (
                                        <div key={msg.id} className={`flex flex-col ${msg.uid === user.uid ? 'items-end' : 'items-start'}`}>
                                            <span className="text-xs text-gray-500 mb-1 px-1">{msg.sender}</span>
                                            <div className={`px-4 py-2 rounded-2xl max-w-[85%] text-sm ${msg.uid === user.uid ? 'bg-blue-500 text-white rounded-tr-none' : 'bg-white border text-gray-800 rounded-tl-none'}`}>
                                                {msg.text}
                                            </div>
                                        </div>
                                    ))}
                                    <div ref={chatEndRef}></div>
                                </div>
                                <div className="p-3 bg-white border-t flex gap-2">
                                    <input 
                                        type="text" 
                                        value={inputMsg} 
                                        onChange={(e)=>setInputMsg(e.target.value)} 
                                        onKeyPress={(e)=>e.key==='Enter' && sendMessage()}
                                        placeholder="ë©”ì‹œì§€ ì…ë ¥..." 
                                        className="flex-1 px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 ring-blue-500"
                                    />
                                    <button onClick={sendMessage} className="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                                        <SendIcon />
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” */}
                    <div className="h-20 bg-gray-800 border-t border-gray-700 flex items-center justify-center gap-6 px-4">
                        <button 
                            onClick={toggleMic} 
                            className={`p-4 rounded-full transition duration-200 flex flex-col items-center justify-center gap-1 w-16 h-16 ${isMicOn ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-red-500 text-white hover:bg-red-600'}`}
                            title="ë§ˆì´í¬ ì¼œê¸°/ë„ê¸°"
                        >
                            {isMicOn ? <MicIcon /> : <MicOffIcon />}
                        </button>

                        <button 
                            onClick={toggleCam} 
                            className={`p-4 rounded-full transition duration-200 flex flex-col items-center justify-center gap-1 w-16 h-16 ${isCamOn ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-red-500 text-white hover:bg-red-600'}`}
                            title="ì¹´ë©”ë¼ ì¼œê¸°/ë„ê¸°"
                        >
                            {isCamOn ? <VideoIcon /> : <VideoOffIcon />}
                        </button>

                        <button 
                            onClick={() => setShowChat(!showChat)} 
                            className={`p-4 rounded-full transition duration-200 flex flex-col items-center justify-center gap-1 w-16 h-16 relative ${showChat ? 'bg-blue-600 text-white' : 'bg-gray-700 text-white hover:bg-gray-600'}`}
                            title="ì±„íŒ…ì°½ ì—´ê¸°/ë‹«ê¸°"
                        >
                            <ChatIcon />
                            {/* ì±„íŒ… ì•Œë¦¼ ë±ƒì§€ (ì„ì‹œ) */}
                            {!showChat && messages.length > 0 && <span className="absolute top-1 right-1 w-3 h-3 bg-red-500 rounded-full border border-gray-800"></span>}
                        </button>

                        <div className="w-px h-10 bg-gray-600 mx-2"></div>

                        <button 
                            onClick={onClose} 
                            className="px-6 py-3 bg-red-600/90 text-white rounded-xl font-bold hover:bg-red-700 transition flex items-center gap-2"
                        >
                            ë‚˜ê°€ê¸°
                        </button>
                    </div>
                </div>
            );
        };

        // --- 8. ëŒ€ì‹œë³´ë“œ ---
        const DashboardView = ({ user, studyPlan, selectedHours, setStep, isCamStudyOpen, setIsCamStudyOpen }) => {
            const activePlans = studyPlan.filter(p => p.content.trim() !== '');
            
            if (isCamStudyOpen) {
                return <CamStudyView user={user} onClose={() => setIsCamStudyOpen(false)} />;
            }

            return (
                <div className="max-w-6xl mx-auto py-8 px-4 fade-in">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-6 flex flex-col md:flex-row justify-between items-center">
                        <div className="mb-4 md:mb-0">
                            <h2 className="text-2xl font-bold text-gray-900">ğŸš€ ë‚˜ë§Œì˜ í•™ìŠµ ê³„íší‘œ</h2>
                            <p className="text-gray-500 mt-1 text-sm">ì˜¤ëŠ˜ ì´ <span className="text-blue-600 font-bold text-lg mx-1">{selectedHours.length}ì‹œê°„</span>ì˜ í•™ìŠµì´ ì˜ˆì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setIsCamStudyOpen(true)} className="flex items-center gap-2 px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-md hover:shadow-lg animate-pulse">
                                <CameraIcon /> ìº  ìŠ¤í„°ë”” ì…ì¥
                            </button>
                            <button onClick={() => setStep('selecting')} className="text-sm bg-gray-50 text-gray-600 border border-gray-200 px-4 py-2 rounded-lg hover:bg-gray-100 transition">ì‹œê°„ ì¬ì„¤ì •</button>
                            <button onClick={() => setStep('details')} className="text-sm bg-blue-50 text-blue-600 border border-blue-100 px-4 py-2 rounded-lg hover:bg-blue-100 transition font-bold flex items-center gap-1"><EditIcon /> ë‚´ìš© ìˆ˜ì •</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div className="lg:col-span-4 space-y-6">
                            <PomodoroTimer />
                            <MusicPlayer />
                        </div>
                        <div className="lg:col-span-8">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 min-h-[600px]">
                                <h3 className="font-bold text-gray-800 mb-6 flex items-center gap-2 pb-4 border-b border-gray-100"><span>ğŸ“</span> ì˜¤ëŠ˜ì˜ í•™ìŠµ ìŠ¤ì¼€ì¤„</h3>
                                <div className="space-y-6">
                                    {activePlans.length === 0 ? (
                                        <div className="text-center py-20 text-gray-400 flex flex-col items-center">
                                            <div className="text-4xl mb-4">ğŸ“­</div>
                                            <p className="mb-4">ì•„ì§ ì‘ì„±ëœ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                            <button onClick={() => setStep('details')} className="text-blue-500 underline hover:text-blue-700">ì§€ê¸ˆ ê³„íš ì„¸ìš°ê¸°</button>
                                        </div>
                                    ) : (
                                        activePlans.map((plan, index) => (
                                            <div key={plan.id} className="flex gap-4 group">
                                                <div className="w-16 text-right pt-3 font-bold text-gray-400 text-lg">{selectedHours[index % selectedHours.length] || selectedHours[0]}:00</div>
                                                <div className={`flex-1 p-5 rounded-2xl text-white shadow-lg transition transform hover:-translate-y-1 hover:shadow-xl bg-gradient-to-r ${plan.color === 'purple' ? 'from-purple-500 to-indigo-500' : plan.color === 'pink' ? 'from-pink-500 to-rose-500' : plan.color === 'orange' ? 'from-orange-400 to-red-400' : 'from-blue-500 to-cyan-500'}`}>
                                                    <div className="flex justify-between items-start mb-3"><span className="font-bold text-xs bg-white/20 px-2 py-1 rounded backdrop-blur-sm border border-white/10">{plan.subject}</span></div>
                                                    <p className="text-lg font-medium leading-relaxed whitespace-pre-wrap">{plan.content}</p>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Navbar = ({ user, handleLogout, setStep, handleManualSave, saveStatus }) => (
            <nav className="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-50">
                <div className="text-2xl font-bold text-gray-800 cursor-pointer" onClick={() => setStep('empty')}>RootEdu</div>
                <div>
                    {user ? (
                        <div className="flex items-center gap-4">
                            <button 
                                onClick={handleManualSave} 
                                disabled={saveStatus === 'saving'}
                                className={`flex items-center gap-1 px-4 py-2 rounded-lg font-bold text-sm transition shadow-sm ${saveStatus === 'saved' ? 'bg-green-50 text-green-600 border border-green-200' : saveStatus === 'error' ? 'bg-red-50 text-red-600 border border-red-200' : 'bg-indigo-50 text-indigo-600 border border-indigo-200 hover:bg-indigo-100'}`}
                            >
                                {saveStatus === 'saving' ? <>â³ ì €ì¥ ì¤‘...</> : saveStatus === 'saved' ? <>âœ… ì €ì¥ë¨</> : <><SaveIcon /> ì €ì¥í•˜ê¸°</>}
                            </button>
                            <div className="h-6 w-px bg-gray-200 mx-2"></div>
                            <span className="hidden md:inline text-gray-600 font-bold">{user.displayName || user.email}ë‹˜</span>
                            <button onClick={handleLogout} className="text-gray-500 hover:text-gray-900 text-sm">ë¡œê·¸ì•„ì›ƒ</button>
                        </div>
                    ) : null}
                </div>
            </nav>
        );

        // --- ë©”ì¸ ì•± ---
        function App() {
            const [user, setUser] = useState(null);
            const [isLoadingData, setIsLoadingData] = useState(true); 
            const [saveStatus, setSaveStatus] = useState('idle');
            const [isCamStudyOpen, setIsCamStudyOpen] = useState(false); // ìº ìŠ¤í„°ë”” ìƒíƒœ ì¶”ê°€
            
            const [step, setStep] = useState('empty'); 
            const [selectedHours, setSelectedHours] = useState([19, 20, 21]); 
            const [currentEditingSubject, setCurrentEditingSubject] = useState('kor');
            const [studyPlan, setStudyPlan] = useState([
                { id: 'kor', subject: 'êµ­ì–´', color: 'purple', content: '' },
                { id: 'math', subject: 'ìˆ˜í•™', color: 'pink', content: '' },
                { id: 'eng', subject: 'ì˜ì–´', color: 'orange', content: '' },
                { id: 'sci', subject: 'íƒêµ¬', color: 'blue', content: '' }
            ]);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        try {
                            const doc = await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('data').doc('planner').get();
                            if (doc.exists) {
                                const data = doc.data();
                                setStep(data.step || 'empty');
                                setSelectedHours(data.selectedHours || []);
                                if (data.studyPlan) setStudyPlan(data.studyPlan);
                            }
                        } catch (err) {
                            console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
                        } finally {
                            setIsLoadingData(false);
                        }
                    } else {
                        setUser(null);
                        setStep('empty');
                        setIsLoadingData(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            const handleManualSave = async () => {
                if (!user) return;
                setSaveStatus('saving');
                try {
                    await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('data').doc('planner').set({
                        step, selectedHours, studyPlan, lastUpdated: new Date()
                    }, { merge: true });
                    setSaveStatus('saved');
                    setTimeout(() => setSaveStatus('idle'), 3000);
                } catch (err) {
                    console.error("ì €ì¥ ì‹¤íŒ¨:", err);
                    setSaveStatus('error');
                    setTimeout(() => setSaveStatus('idle'), 3000);
                }
            };

            const handleLogout = () => { auth.signOut(); };

            if (!user) return <AuthView setIsLoggedIn={() => {}} />;
            if (isLoadingData) return <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50"><div className="loader mb-4"></div><p className="text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p></div>;

            return (
                <div className="min-h-screen pb-10">
                    <Navbar user={user} handleLogout={handleLogout} setStep={setStep} handleManualSave={handleManualSave} saveStatus={saveStatus} />
                    {step === 'empty' && <EmptyPlanView setStep={setStep} />}
                    {step === 'selecting' && <TimeSelectionView selectedHours={selectedHours} setSelectedHours={setSelectedHours} setStep={setStep} />}
                    {step === 'details' && <DetailInputView studyPlan={studyPlan} setStudyPlan={setStudyPlan} setStep={setStep} currentEditingSubject={currentEditingSubject} setCurrentEditingSubject={setCurrentEditingSubject} />}
                    {step === 'dashboard' && <DashboardView user={user} studyPlan={studyPlan} selectedHours={selectedHours} setStep={setStep} isCamStudyOpen={isCamStudyOpen} setIsCamStudyOpen={setIsCamStudyOpen} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
