<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RohEdu - Premium Cam Study</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f3f4f6; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .glass-panel { background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #9333ea; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #4b5563; border-radius: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // ğŸ”´ ê´€ë¦¬ì ì´ë©”ì¼ ì„¤ì •
        // ==========================================
        const ADMIN_EMAILS = [
            "qwer@qwer.com", 
            "admin@test.com"
        ];

        // ==========================================
        // íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì •
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBxugw1-vlMbFXqQZELbCazf2Tv2qmeg4Q",
            authDomain: "roh-project-3714f.firebaseapp.com",
            projectId: "roh-project-3714f",
            storageBucket: "roh-project-3714f.firebasestorage.app",
            messagingSenderId: "1060646116552",
            appId: "1:1060646116552:web:0d29a18fb9540e59c899fd",
            measurementId: "G-J57FTVWXNR"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        if (!firebase.apps.length) {
            try { firebase.initializeApp(firebaseConfig); } catch (error) { console.error("Firebase Init Error", error); }
        }
        
        const db = firebase.firestore();
        const auth = firebase.auth();

        const { useState, useEffect, useRef } = React;

        // --- ì•„ì´ì½˜ë“¤ ---
        const Icons = {
            Edit: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>,
            Google: () => <svg className="w-5 h-5 mr-2" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>,
            Search: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>,
            Save: () => <svg className="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>,
            Camera: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 002 2z"></path></svg>,
            Reset: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>,
            Play: () => <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>,
            Pause: () => <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>,
            Mic: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>,
            MicOff: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clipRule="evenodd"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path></svg>,
            Video: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>,
            VideoOff: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>,
            Chat: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>,
            Gear: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>,
            Notice: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>,
            Music: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path></svg>,
            Speaker: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>,
            Sync: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
        };

        // --- 1. ë¡œê·¸ì¸/íšŒì›ê°€ì… ---
        const AuthView = ({ setIsLoggedIn }) => {
            const [isLoginMode, setIsLoginMode] = useState(true);
            const [name, setName] = useState("");
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");
            const [loading, setLoading] = useState(false);

            const getUserDocRef = (uid) => db.collection('artifacts').doc(appId).collection('users').doc(uid).collection('data').doc('planner');

            const handleGoogleLogin = async () => {
                setError(""); setLoading(true);
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    const result = await auth.signInWithPopup(provider);
                    const user = result.user;
                    const userDocRef = getUserDocRef(user.uid);
                    const userDoc = await userDocRef.get();
                    if (!userDoc.exists) {
                        await userDocRef.set({
                            name: user.displayName || "Google User", email: user.email, step: 'empty', selectedHours: [19, 20, 21],
                            studyPlan: [{id:'kor',subject:'êµ­ì–´',color:'purple',content:''},{id:'math',subject:'ìˆ˜í•™',color:'pink',content:''},{id:'eng',subject:'ì˜ì–´',color:'orange',content:''},{id:'sci',subject:'íƒêµ¬',color:'blue',content:''}]
                        });
                    }
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            };

            const handleEmailAuth = async () => {
                setError(""); setLoading(true);
                try {
                    if (isLoginMode) await auth.signInWithEmailAndPassword(email, password);
                    else {
                        if (!name) throw new Error("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        await userCredential.user.updateProfile({ displayName: name });
                        await getUserDocRef(userCredential.user.uid).set({
                            name: name, email: email, step: 'empty', selectedHours: [19, 20, 21],
                            studyPlan: [{id:'kor',subject:'êµ­ì–´',color:'purple',content:''},{id:'math',subject:'ìˆ˜í•™',color:'pink',content:''},{id:'eng',subject:'ì˜ì–´',color:'orange',content:''},{id:'sci',subject:'íƒêµ¬',color:'blue',content:''}]
                        });
                    }
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 fade-in px-4">
                    <div className="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md text-center">
                        <h1 className="text-3xl font-bold text-blue-600 mb-2">RootEdu</h1>
                        <p className="text-gray-400 mb-6">{isLoginMode ? "ëŒì•„ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!" : "ë‚˜ë§Œì˜ í”Œë˜ë„ˆë¥¼ ì‹œì‘í•˜ì„¸ìš”"}</p>
                        <button onClick={handleGoogleLogin} className="w-full bg-white border border-gray-300 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-50 mb-6 flex items-center justify-center"><Icons.Google />Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°</button>
                        <div className="relative mb-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-200"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-gray-500">ë˜ëŠ” ì´ë©”ì¼ë¡œ ì‹œì‘</span></div></div>
                        {!isLoginMode && <input type="text" placeholder="ì´ë¦„" value={name} onChange={e=>setName(e.target.value)} className="w-full mb-3 p-3 border rounded-lg bg-gray-50 outline-none focus:ring-2 ring-blue-200" />}
                        <input type="email" placeholder="ì´ë©”ì¼" value={email} onChange={e=>setEmail(e.target.value)} className="w-full mb-3 p-3 border rounded-lg bg-gray-50 outline-none focus:ring-2 ring-blue-200" />
                        <input type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value={password} onChange={e=>setPassword(e.target.value)} className="w-full mb-3 p-3 border rounded-lg bg-gray-50 outline-none focus:ring-2 ring-blue-200" onKeyPress={(e) => e.key === 'Enter' && handleEmailAuth()} />
                        {error && <p className="text-red-500 text-sm mb-4 break-keep">{error}</p>}
                        <button onClick={handleEmailAuth} disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition active:scale-95 shadow-md flex justify-center">{loading ? "ì²˜ë¦¬ì¤‘..." : (isLoginMode ? "ë¡œê·¸ì¸" : "íšŒì›ê°€ì…")}</button>
                        <div className="mt-4 text-sm text-gray-500">{isLoginMode ? "ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?" : "ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?"} <button onClick={() => {setIsLoginMode(!isLoginMode); setError("");}} className="text-blue-600 font-bold ml-2 underline">{isLoginMode ? "íšŒì›ê°€ì…í•˜ê¸°" : "ë¡œê·¸ì¸í•˜ê¸°"}</button></div>
                    </div>
                </div>
            );
        };

        // --- 2~4. í”Œë˜ë„ˆ ë·°ë“¤ ---
        const EmptyPlanView = ({ setStep }) => (
            <div className="flex flex-col items-center justify-center min-h-[80vh] px-4 fade-in">
                <div className="bg-white p-10 rounded-3xl shadow-lg max-w-lg w-full text-center border border-gray-100">
                    <div className="text-6xl mb-4">ğŸ“…</div>
                    <h2 className="text-2xl font-bold text-gray-900 mb-2">ì˜¤ëŠ˜ì˜ í•™ìŠµ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤</h2>
                    <p className="text-gray-500 mb-8">ì‹œê°„ì„ ì •í•˜ê³  ìƒì„¸ ê³„íšì„ ì„¸ì›Œë³´ì„¸ìš”.</p>
                    <button onClick={() => setStep('selecting')} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-700 transition shadow-lg shadow-blue-200">âœ¨ ë§ì¶¤ í•™ìŠµ ê³„íš ë§Œë“¤ê¸° â†’</button>
                </div>
            </div>
        );

        const TimeSelectionView = ({ selectedHours, setSelectedHours, setStep }) => {
            const pmHours = Array.from({ length: 12 }, (_, i) => i + 12);
            const toggleHour = (hour) => {
                if (selectedHours.includes(hour)) setSelectedHours(prev => prev.filter(h => h !== hour));
                else setSelectedHours(prev => [...prev, hour].sort((a, b) => a - b));
            };
            return (
                <div className="flex justify-center py-10 px-4 fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 w-full max-w-3xl">
                        <h3 className="text-xl font-bold text-gray-900 mb-6">1. í•™ìŠµ ì‹œê°„ ì„ íƒ</h3>
                        <div className="grid grid-cols-6 gap-2 mb-8 select-none">
                            {pmHours.map(hour => (
                                <div key={hour} onClick={() => toggleHour(hour)} className={`cursor-pointer rounded-xl p-4 text-center border transition-colors duration-200 ${selectedHours.includes(hour) ? 'bg-blue-500 text-white border-blue-600 shadow-md' : 'bg-gray-50 border-gray-200 hover:bg-gray-100'}`}>
                                    <div className="font-bold text-lg">{hour}ì‹œ</div>
                                </div>
                            ))}
                        </div>
                        <button onClick={() => { if(selectedHours.length === 0) return alert("ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!"); setStep('details'); }} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">ë‹¤ìŒ ë‹¨ê³„ (í•  ì¼ ì…ë ¥) â†’</button>
                    </div>
                </div>
            );
        };

        const DetailInputView = ({ studyPlan, setStudyPlan, setStep, currentEditingSubject, setCurrentEditingSubject }) => {
            const currentSubjectData = studyPlan.find(s => s.id === currentEditingSubject);
            const handleChange = (e) => setStudyPlan(prevPlan => prevPlan.map(s => s.id === currentEditingSubject ? { ...s, content: e.target.value } : s));
            return (
                <div className="flex justify-center py-10 px-4 fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 w-full max-w-3xl">
                        <h3 className="text-xl font-bold text-gray-900 mb-6">2. ê³¼ëª©ë³„ í•  ì¼ ì…ë ¥</h3>
                        <div className="flex flex-col md:flex-row gap-6">
                            <div className="md:w-1/3 space-y-3">
                                {studyPlan.map(sub => (
                                    <button key={sub.id} onClick={() => setCurrentEditingSubject(sub.id)} className={`w-full text-left p-4 rounded-xl flex justify-between items-center border ${currentEditingSubject === sub.id ? `bg-${sub.color}-50 border-${sub.color}-500 ring-1 ring-${sub.color}-500` : 'bg-white border-gray-200 hover:bg-gray-50'}`}>
                                        <span className={`font-bold text-${sub.color === 'orange' ? 'yellow' : sub.color}-600`}>{sub.subject}</span>
                                        {sub.content && <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">ì‘ì„±ë¨</span>}
                                    </button>
                                ))}
                            </div>
                            <div className="md:w-2/3">
                                <textarea className="w-full h-48 p-4 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none resize-none bg-gray-50 text-gray-800 text-lg" placeholder={`ì˜ˆ: ${currentSubjectData.subject} ê¸°ì¶œë¬¸ì œ í’€ê¸°...`} value={currentSubjectData.content} onChange={handleChange}></textarea>
                            </div>
                        </div>
                        <div className="mt-8 pt-6 border-t flex justify-between">
                            <button onClick={() => setStep('selecting')} className="text-gray-500 font-medium px-4">â† ì´ì „</button>
                            <button onClick={() => setStep('dashboard')} className="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition">ê³„íší‘œ ì™„ì„±í•˜ê¸° âœ“</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 5. ë½€ëª¨ë„ë¡œ íƒ€ì´ë¨¸ ---
        const PomodoroTimer = () => {
            const [timeLeft, setTimeLeft] = useState(25 * 60);
            const [isActive, setIsActive] = useState(false);
            const [mode, setMode] = useState('focus');
            useEffect(() => {
                let interval = null;
                if (isActive && timeLeft > 0) interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
                else if (timeLeft === 0) { setIsActive(false); alert(mode === 'focus' ? "ì§‘ì¤‘ ì‹œê°„ ë! íœ´ì‹í•˜ì„¸ìš”." : "íœ´ì‹ ë! ë‹¤ì‹œ ì§‘ì¤‘í•˜ì„¸ìš”."); }
                return () => clearInterval(interval);
            }, [isActive, timeLeft, mode]);
            const changeMode = (newMode) => { setMode(newMode); setIsActive(false); setTimeLeft(newMode === 'focus' ? 25 * 60 : 5 * 60); };
            const formatTime = (seconds) => { const m = Math.floor(seconds / 60).toString().padStart(2, '0'); const s = (seconds % 60).toString().padStart(2, '0'); return `${m}:${s}`; };
            const isFocus = mode === 'focus';
            return (
                <div className={`p-6 rounded-2xl shadow-lg border transition-colors duration-500 ${isFocus ? 'bg-red-50 border-red-100' : 'bg-green-50 border-green-100'}`}>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className={`font-bold text-lg ${isFocus ? 'text-red-600' : 'text-green-600'}`}>{isFocus ? 'ğŸ”¥ ì§‘ì¤‘ ëª¨ë“œ' : 'â˜• íœ´ì‹ ëª¨ë“œ'}</h3>
                        <div className="flex gap-2 text-sm"><button onClick={() => changeMode('focus')} className={`px-3 py-1 rounded-md ${isFocus ? 'bg-red-500 text-white' : 'bg-white text-gray-500 border'}`}>25ë¶„</button><button onClick={() => changeMode('break')} className={`px-3 py-1 rounded-md ${!isFocus ? 'bg-green-500 text-white' : 'bg-white text-gray-500 border'}`}>5ë¶„</button></div>
                    </div>
                    <div className="flex flex-col items-center justify-center py-4">
                        <div className={`text-7xl font-mono font-bold tracking-tighter mb-6 ${isFocus ? 'text-red-500' : 'text-green-500'}`}>{formatTime(timeLeft)}</div>
                        <div className="flex gap-4">
                            <button onClick={() => setIsActive(!isActive)} className={`flex items-center gap-2 px-8 py-3 rounded-full text-white font-bold text-lg shadow-md hover:opacity-90 active:scale-95 transition ${isFocus ? 'bg-red-500' : 'bg-green-500'}`}>{isActive ? <><Icons.Pause /> ì¼ì‹œì •ì§€</> : <><Icons.Play /> ì‹œì‘</>}</button>
                            <button onClick={() => { setIsActive(false); setTimeLeft(isFocus ? 25 * 60 : 5 * 60); }} className="p-3 rounded-full bg-white border border-gray-200 text-gray-500 hover:bg-gray-100"><Icons.Reset /></button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 6. (ê°œì¸ìš©) ë®¤ì§ í”Œë ˆì´ì–´ ---
        const MusicPlayer = () => {
            const [videoId, setVideoId] = useState("jfKfPfyJRdk");
            const [inputUrl, setInputUrl] = useState("");
            const presets = [ { name: "ğŸ§ Lofi Girl", id: "jfKfPfyJRdk" }, { name: "â˜• Cafe Jazz", id: "5qap5aO4i9A" }, { name: "ğŸŒ§ï¸ ë¹—ì†Œë¦¬", id: "mPZkdNFkNps" }, { name: "ğŸ¹ í”¼ì•„ë…¸", id: "7J_M3p_z0c0" } ];
            const extractVideoId = (url) => { if (!url) return ""; const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/; const match = url.match(regExp); return (match && match[2].length === 11) ? match[2] : url; };
            const handlePlay = () => { const id = extractVideoId(inputUrl); if (id) { setVideoId(id); setInputUrl(""); } else alert("ì˜¬ë°”ë¥¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); };
            const handleSearch = () => { if (!inputUrl) return alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!"); window.open(`https://www.youtube.com/results?search_query=study+music+${encodeURIComponent(inputUrl)}`, '_blank'); };

            return (
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-6">
                    <h3 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">ğŸµ í•™ìŠµ BGM í”Œë ˆì´ì–´ (ê°œì¸)</h3>
                    <div className="aspect-video w-full bg-black rounded-xl overflow-hidden mb-4 shadow-inner">
                        <iframe width="100%" height="100%" src={`https://www.youtube.com/embed/${videoId}?rel=0&playsinline=1&modestbranding=1`} title="YouTube video player" frameBorder="0" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen></iframe>
                    </div>
                    <div className="flex gap-2 overflow-x-auto pb-2 mb-4 scrollbar-hide">
                        {presets.map(p => ( <button key={p.id} onClick={() => setVideoId(p.id)} className="px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap transition border bg-gray-50 text-gray-600 hover:bg-gray-100">{p.name}</button> ))}
                    </div>
                    <div className="flex gap-2">
                        <input type="text" placeholder="ê²€ìƒ‰ì–´ ë˜ëŠ” ìœ íŠœë¸Œ ì£¼ì†Œ" value={inputUrl} onChange={(e) => setInputUrl(e.target.value)} className="flex-1 px-4 py-2 border border-gray-200 rounded-lg text-sm outline-none focus:ring-2 ring-indigo-100" onKeyPress={(e) => e.key === 'Enter' && handlePlay()} />
                        <button onClick={handleSearch} className="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition"><Icons.Search /></button>
                        <button onClick={handlePlay} className="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition">ë¡œë”©</button>
                    </div>
                </div>
            );
        };

        // ==================================================================================
        // ğŸš€ [Cam Study View]
        // ==================================================================================
        const CamStudyView = ({ user, onClose, isAdmin }) => {
            const [localStream, setLocalStream] = useState(null);
            const [remoteUsers, setRemoteUsers] = useState({});
            const [dbUsers, setDbUsers] = useState({});
            
            const [isMicOn, setIsMicOn] = useState(true);
            const [isCamOn, setIsCamOn] = useState(true);
            const [showChat, setShowChat] = useState(false);
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [showMusicPanel, setShowMusicPanel] = useState(false);
            const [showRanking, setShowRanking] = useState(false);
            
            // ë°ì´í„°
            const [messages, setMessages] = useState([]);
            const [inputMsg, setInputMsg] = useState("");
            const [notice, setNotice] = useState("");
            const [globalTimer, setGlobalTimer] = useState({ isRunning: false, startAt: 0 });
            const [timerDisplay, setTimerDisplay] = useState("00:00:00");
            const [bannedUsers, setBannedUsers] = useState({});
            
            // DJ (Shared Music)
            const [djMode, setDjMode] = useState({ videoId: '', isPlaying: false, startedAt: 0 });
            const [djInput, setDjInput] = useState("");
            const [volume, setVolume] = useState(50); 
            const djIframeRef = useRef(null);

            const peerRef = useRef(null);
            const localVideoRef = useRef(null);
            const chatEndRef = useRef(null);
            const userDocRef = useRef(null);
            const studyTimeInterval = useRef(null);

            useEffect(() => {
                const init = async () => {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                        setLocalStream(stream);
                        if(localVideoRef.current) localVideoRef.current.srcObject = stream;

                        const peer = new Peer();
                        peerRef.current = peer;

                        peer.on('open', async (id) => {
                            userDocRef.current = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('cam_study').doc(user.uid);
                            await userDocRef.current.set({
                                peerId: id, name: user.displayName || user.email, studyTime: firebase.firestore.FieldValue.increment(0),
                                lastActive: firebase.firestore.FieldValue.serverTimestamp()
                            }, { merge: true });

                            studyTimeInterval.current = setInterval(() => {
                                userDocRef.current.update({ studyTime: firebase.firestore.FieldValue.increment(1) });
                            }, 60000);
                        });

                        peer.on('call', (call) => {
                            call.answer(stream);
                            call.on('stream', (rs) => setRemoteUsers(prev => ({ ...prev, [call.peer]: { stream: rs } })));
                        });
                        
                        window.addEventListener('beforeunload', () => userDocRef.current.delete());
                    } catch(err) { alert("ë¯¸ë””ì–´ ê¶Œí•œ í•„ìš”"); onClose(); }
                };
                init();
                return () => {
                    if(peerRef.current) peerRef.current.destroy();
                    if(localStream) localStream.getTracks().forEach(t => t.stop());
                    if(userDocRef.current) userDocRef.current.delete();
                    if(studyTimeInterval.current) clearInterval(studyTimeInterval.current);
                };
            }, []);

            useEffect(() => {
                // 1. Config Listener
                const configUnsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('cam_config').doc('main')
                    .onSnapshot(doc => {
                        const data = doc.data() || {};
                        setNotice(data.notice || "");
                        setGlobalTimer(data.timer || { isRunning: false });
                        setBannedUsers(data.kicked || {});
                        
                        if(data.kicked && data.kicked[user.uid]) { 
                            alert("ê´€ë¦¬ìì— ì˜í•´ í‡´ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                            window.location.reload(); 
                        }
                        if(data.forceMute && !isAdmin && localStream) {
                            localStream.getAudioTracks()[0].enabled = false; setIsMicOn(false);
                        }
                    });

                // 2. Music Listener (With Sync)
                const musicUnsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('cam_config').doc('music')
                    .onSnapshot(doc => {
                        const data = doc.data() || { videoId: '', isPlaying: false, startedAt: 0 };
                        setDjMode(data);
                        
                        // Auto-Sync Logic (when new song plays)
                        if(data.isPlaying && data.startedAt && djIframeRef.current) {
                            const elapsed = (Date.now() - data.startedAt) / 1000;
                            if(elapsed > 1) { // 1ì´ˆ ì´ìƒ ì°¨ì´ë‚˜ë©´ ì‹±í¬ ë§ì¶¤
                                djIframeRef.current.contentWindow.postMessage(JSON.stringify({
                                    event: 'command', func: 'seekTo', args: [elapsed, true]
                                }), '*');
                            }
                        }
                    });

                // 3. User & Peer Sync
                const usersUnsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('cam_study')
                    .onSnapshot(snapshot => {
                        const users = {};
                        snapshot.docs.forEach(doc => {
                            const d = doc.data();
                            users[d.peerId] = { ...d, uid: doc.id };
                            if(doc.id !== user.uid && d.peerId && peerRef.current) {
                                setRemoteUsers(prev => {
                                    if(prev[d.peerId]) return prev;
                                    if(peerRef.current.id > d.peerId) {
                                        const call = peerRef.current.call(d.peerId, localStream);
                                        if(call) call.on('stream', rs => setRemoteUsers(p => ({...p, [d.peerId]: {stream: rs}})));
                                    }
                                    return prev;
                                });
                            }
                        });
                        setDbUsers(users);
                    });
                
                // 4. Chat
                const chatUnsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('chat_messages')
                    .orderBy('createdAt', 'asc').limit(50)
                    .onSnapshot(snap => {
                        setMessages(snap.docs.map(d => ({id: d.id, ...d.data()})));
                        if(chatEndRef.current) chatEndRef.current.scrollIntoView();
                    });

                return () => { configUnsub(); musicUnsub(); usersUnsub(); chatUnsub(); };
            }, [localStream]);

            // Timer Logic
            useEffect(() => {
                let interval;
                if(globalTimer.isRunning || isAdmin) {
                    interval = setInterval(() => {
                        if(!globalTimer.isRunning && !isAdmin) return;
                        const diff = Math.floor((Date.now() - (globalTimer.startAt || Date.now())) / 1000);
                        const h = Math.floor(diff / 3600).toString().padStart(2, '0');
                        const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
                        const s = (diff % 60).toString().padStart(2, '0');
                        setTimerDisplay(`${h}:${m}:${s}`);
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [globalTimer, isAdmin]);

            // --- Admin Functions ---
            const updateConfig = (k, v) => db.collection('artifacts').doc(appId).collection('public').doc('data').collection('cam_config').doc('main').set({[k]: v}, {merge: true});
            const handleKick = (uid, name) => { if(confirm("ê°•í‡´?")) updateConfig('kicked', { ...bannedUsers, [uid]: name }); };
            const handleUnban = (uid) => { const newBanned = { ...bannedUsers }; delete newBanned[uid]; updateConfig('kicked', newBanned); };
            const toggleTimer = () => updateConfig('timer', { isRunning: !globalTimer.isRunning, startAt: !globalTimer.isRunning ? Date.now() : globalTimer.startAt });
            const resetTimer = () => { updateConfig('timer', { isRunning: false, startAt: Date.now() }); setTimerDisplay("00:00:00"); };
            const postNotice = () => { const t = prompt("ê³µì§€ ë‚´ìš©:"); if(t) updateConfig('notice', t); };
            const toggleMuteAll = () => { if(confirm("ì „ì²´ ìŒì†Œê±°?")) { updateConfig('forceMute', true); setTimeout(()=>updateConfig('forceMute',false), 2000); }};
            
            // --- Shared Music Functions (With Sync) ---
            const updateDj = async (data) => db.collection('artifacts').doc(appId).collection('public').doc('data').collection('cam_config').doc('music').set(data, {merge:true});
            const handleDjPlay = () => {
                const id = extractVideoId(djInput);
                if(id) { 
                    updateDj({ videoId: id, isPlaying: true, startedAt: Date.now() }); // ì‹œê°„ ê¸°ë¡
                    setDjInput(""); 
                }
            };
            const extractVideoId = (url) => { if (!url) return ""; const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/; const match = url.match(regExp); return (match && match[2].length === 11) ? match[2] : url; };
            
            // ë³¼ë¥¨ ì¡°ì ˆ
            const handleVolumeChange = (e) => {
                const newVol = e.target.value; setVolume(newVol);
                if (djIframeRef.current) djIframeRef.current.contentWindow.postMessage(JSON.stringify({ event: 'command', func: 'setVolume', args: [newVol] }), '*');
            };
            
            // ìˆ˜ë™ ì‹±í¬
            const handleSync = () => {
                if(djMode.isPlaying && djMode.startedAt && djIframeRef.current) {
                    const elapsed = (Date.now() - djMode.startedAt) / 1000;
                    djIframeRef.current.contentWindow.postMessage(JSON.stringify({ event: 'command', func: 'seekTo', args: [elapsed, true] }), '*');
                    alert("ì‹±í¬ê°€ ë§ì¶°ì¡ŒìŠµë‹ˆë‹¤.");
                }
            };

            const sendMessage = async () => { if(inputMsg.trim()) { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('chat_messages').add({text: inputMsg, sender: user.displayName, uid: user.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp()}); setInputMsg(""); }};

            const RemoteVideo = ({ peerId, stream }) => {
                const videoRef = useRef();
                const uData = dbUsers[peerId] || {};
                useEffect(() => { if(videoRef.current) videoRef.current.srcObject = stream; }, [stream]);
                return (
                    <div className="relative aspect-video bg-gray-800 rounded-xl overflow-hidden shadow-lg group border border-gray-700">
                        <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover" />
                        <div className="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black/80 to-transparent flex justify-between items-end">
                            <span className="text-white text-sm font-bold truncate">{uData.name || "ìµëª…"}</span>
                            {isAdmin && <button onClick={() => handleKick(uData.uid, uData.name)} className="bg-red-600 text-white text-xs px-2 py-1 rounded hover:bg-red-700 opacity-0 group-hover:opacity-100 transition">ê°•í‡´</button>}
                        </div>
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 z-50 bg-[#121212] flex flex-col text-white">
                    {notice && <div className="bg-indigo-600 px-4 py-2 flex items-center justify-center gap-2 animate-pulse text-sm font-bold shadow-lg z-50"><Icons.Notice /> <span>[ê³µì§€] {notice}</span>{isAdmin && <button onClick={() => updateConfig('notice', '')} className="ml-4 opacity-70">âœ•</button>}</div>}
                    
                    <div className="h-16 flex items-center justify-between px-6 border-b border-gray-800 bg-[#1E1E1E]">
                        <div className="flex items-center gap-4">
                            <h2 className="text-lg font-bold">ğŸ“· Cam Study</h2>
                            {(globalTimer.isRunning || isAdmin) && <div className="flex items-center gap-2 px-3 py-1 rounded-lg border border-red-500 text-red-400 font-mono font-bold text-xl">{timerDisplay}{isAdmin && <div className="flex gap-1 ml-2"><button onClick={toggleTimer} className="text-xs">{globalTimer.isRunning?'â¹':'â–¶'}</button><button onClick={resetTimer} className="text-xs">â†º</button></div>}</div>}
                        </div>
                        <div className="flex gap-2">
                            {djMode.isPlaying && djMode.videoId && <div className="flex items-center gap-2 bg-purple-900/50 px-3 py-1 rounded-full border border-purple-500/30"><span className="animate-pulse">ğŸµ</span> <span className="text-xs text-purple-200">DJ ì¬ìƒì¤‘</span></div>}
                            <button onClick={() => setShowRanking(!showRanking)} className="p-2 hover:bg-gray-700 rounded-full">ğŸ† ë­í‚¹</button>
                        </div>
                    </div>

                    <div className="flex-1 flex overflow-hidden relative">
                        <div className="flex-1 p-4 overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 content-start">
                            <div className="relative aspect-video bg-black rounded-xl overflow-hidden border-2 border-indigo-500 shadow-xl">
                                <video ref={localVideoRef} autoPlay playsInline muted className={`w-full h-full object-cover transform scale-x-[-1] ${!isCamOn && 'hidden'}`} />
                                {!isCamOn && <div className="absolute inset-0 flex items-center justify-center text-gray-500">ì¹´ë©”ë¼ êº¼ì§</div>}
                                <div className="absolute bottom-2 left-2 bg-indigo-600 text-xs px-2 py-1 rounded font-bold">ë‚˜ ({user.displayName})</div>
                            </div>
                            {Object.entries(remoteUsers).map(([pid, u]) => <RemoteVideo key={pid} peerId={pid} stream={u.stream} />)}
                        </div>

                        {showRanking && (
                            <div className="absolute top-4 right-4 w-64 glass-panel rounded-xl p-4 z-40 text-white fade-in">
                                <h3 className="font-bold border-b border-gray-600 pb-2 mb-2 flex justify-between">ğŸ”¥ ì‹¤ì‹œê°„ ë­í‚¹ <button onClick={()=>setShowRanking(false)}>âœ•</button></h3>
                                <div className="space-y-2 max-h-60 overflow-y-auto">{Object.values(dbUsers).sort((a,b)=>(b.studyTime||0)-(a.studyTime||0)).map((u, i) => (<div key={i} className="flex justify-between text-sm"><span className={`w-6 text-center font-bold ${i<3?'text-yellow-400':'text-gray-400'}`}>{i+1}</span><span className="truncate flex-1">{u.name}</span><span className="font-mono">{u.studyTime||0}ë¶„</span></div>))}</div>
                            </div>
                        )}

                        {showChat && (
                            <div className="w-80 bg-[#1E1E1E] border-l border-gray-800 flex flex-col z-20">
                                <div className="p-3 border-b border-gray-700 font-bold flex justify-between">ì±„íŒ… <button onClick={()=>setShowChat(false)}>âœ•</button></div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3">{messages.map(m => (<div key={m.id} className={`flex flex-col ${m.uid===user.uid?'items-end':'items-start'}`}><span className="text-[10px] text-gray-400">{m.sender}</span><div className={`px-3 py-1.5 rounded-lg text-sm ${m.uid===user.uid?'bg-indigo-600':'bg-gray-700'}`}>{m.text}</div></div>))}<div ref={chatEndRef}/></div>
                                <div className="p-3 border-t border-gray-700 flex gap-2"><input value={inputMsg} onChange={e=>setInputMsg(e.target.value)} onKeyPress={e=>e.key==='Enter'&&sendMessage()} className="flex-1 bg-gray-800 rounded px-3 py-2 text-sm text-white" placeholder="ë©”ì‹œì§€..." /><button onClick={sendMessage} className="text-indigo-400 font-bold">ì „ì†¡</button></div>
                            </div>
                        )}

                        <div className={`w-80 bg-[#1E1E1E] border-l border-gray-800 flex flex-col z-20 glass-panel border-l-0 border-r border-gray-700 absolute left-0 top-0 bottom-0 transition-transform duration-300 ${showMusicPanel ? 'translate-x-0' : '-translate-x-full opacity-0 pointer-events-none'}`}>
                            <div className="p-4 border-b border-gray-700 font-bold flex justify-between text-purple-400"><span>ğŸµ DJ í”Œë ˆì´ì–´</span><button onClick={()=>setShowMusicPanel(false)}>âœ•</button></div>
                            <div className="p-4">
                                <div className="aspect-video bg-black rounded-lg overflow-hidden mb-4 shadow-lg border border-purple-500/30 relative">
                                    {djMode.videoId ? (
                                        <iframe ref={djIframeRef} width="100%" height="100%" src={`https://www.youtube.com/embed/${djMode.videoId}?enablejsapi=1&autoplay=${djMode.isPlaying?1:0}`} frameBorder="0" allow="autoplay; encrypted-media" allowFullScreen></iframe>
                                    ) : <div className="h-full flex items-center justify-center text-gray-500 text-sm">ë…¸ë˜ ì—†ìŒ</div>}
                                </div>
                                <div className="mb-2 flex items-center gap-3"><Icons.Speaker /><input type="range" min="0" max="100" value={volume} onChange={handleVolumeChange} className="flex-1"/><span className="text-xs w-6">{volume}</span></div>
                                <div className="flex justify-end mb-4"><button onClick={handleSync} className="text-xs flex items-center gap-1 text-gray-400 hover:text-white border border-gray-600 rounded px-2 py-1"><Icons.Sync /> ì‹±í¬ ë§ì¶”ê¸°</button></div>
                                <div className="flex gap-2 mb-4"><input value={djInput} onChange={e=>setDjInput(e.target.value)} className="flex-1 bg-gray-800 rounded px-3 py-2 text-sm text-white border border-gray-700" placeholder="ìœ íŠœë¸Œ ì£¼ì†Œ..." /><button onClick={handleDjPlay} className="bg-purple-600 hover:bg-purple-700 text-white px-3 rounded font-bold">ì¬ìƒ</button></div>
                                <div className="bg-gray-800 p-3 rounded text-xs text-gray-400">â€» ì°½ì„ ë‹«ì•„ë„ ë…¸ë˜ëŠ” ê³„ì† ë‚˜ì˜µë‹ˆë‹¤.<br/>â€» ì¬ìƒ ì‹œ <b className="text-white">ëª¨ë“  ì‚¬ëŒ</b>ì˜ ë…¸ë˜ê°€ ë°”ë€ë‹ˆë‹¤.</div>
                            </div>
                        </div>
                    </div>

                    {isAdmin && showAdminPanel && (
                        <div className="absolute bottom-24 left-1/2 transform -translate-x-1/2 bg-[#252525] border border-gray-700 rounded-xl p-4 shadow-2xl z-50 w-80 fade-in">
                            <h4 className="text-center font-bold text-yellow-500 mb-4 border-b border-gray-700 pb-2">ğŸ‘‘ ê´€ë¦¬ì ì»¨íŠ¸ë¡¤</h4>
                            <div className="grid grid-cols-2 gap-3 mb-4"><button onClick={postNotice} className="bg-gray-700 hover:bg-gray-600 p-2 rounded text-sm">ğŸ“¢ ê³µì§€ ë“±ë¡</button><button onClick={toggleMuteAll} className="bg-gray-700 hover:bg-gray-600 p-2 rounded text-sm">ğŸ”‡ ì „ì²´ ìŒì†Œê±°</button><button onClick={toggleTimer} className="bg-gray-700 hover:bg-gray-600 p-2 rounded text-sm">â± íƒ€ì´ë¨¸ {globalTimer.isRunning ? 'ì¤‘ì§€':'ì‹œì‘'}</button><button onClick={resetTimer} className="bg-gray-700 hover:bg-gray-600 p-2 rounded text-sm">â†º íƒ€ì´ë¨¸ ë¦¬ì…‹</button></div>
                            <div className="border-t border-gray-700 pt-3"><h5 className="text-xs font-bold text-gray-400 mb-2">ğŸš« ì°¨ë‹¨ëœ ìœ ì € ê´€ë¦¬</h5><div className="max-h-32 overflow-y-auto space-y-1">{Object.keys(bannedUsers).length === 0 && <div className="text-xs text-gray-600 text-center">ì°¨ë‹¨ ë‚´ì—­ ì—†ìŒ</div>}{Object.entries(bannedUsers).map(([uid, name]) => (<div key={uid} className="flex justify-between items-center bg-gray-800 px-2 py-1 rounded text-xs"><span>{name}</span><button onClick={()=>handleUnban(uid)} className="text-green-400 hover:text-green-300 font-bold">í•´ì œ</button></div>))}</div></div>
                        </div>
                    )}

                    <div className="h-20 bg-[#1E1E1E] border-t border-gray-800 flex items-center justify-center gap-4">
                        <button onClick={() => { setIsMicOn(!isMicOn); localStream.getAudioTracks()[0].enabled = !isMicOn; }} className={`p-4 rounded-full ${isMicOn ? 'bg-gray-700' : 'bg-red-500'}`}>{isMicOn ? <Icons.Mic/> : <Icons.MicOff/>}</button>
                        <button onClick={() => { setIsCamOn(!isCamOn); localStream.getVideoTracks()[0].enabled = !isCamOn; }} className={`p-4 rounded-full ${isCamOn ? 'bg-gray-700' : 'bg-red-500'}`}>{isCamOn ? <Icons.Video/> : <Icons.VideoOff/>}</button>
                        <button onClick={() => setShowChat(!showChat)} className={`p-4 rounded-full ${showChat ? 'bg-blue-600' : 'bg-gray-700'}`}><Icons.Chat/></button>
                        <button onClick={() => setShowMusicPanel(!showMusicPanel)} className={`p-4 rounded-full ${showMusicPanel ? 'bg-purple-600' : 'bg-gray-700 hover:text-purple-400'}`}><Icons.Music/></button>
                        {isAdmin && <button onClick={() => setShowAdminPanel(!showAdminPanel)} className={`p-4 rounded-full ${showAdminPanel ? 'bg-yellow-600' : 'bg-gray-700 text-yellow-500'}`}><Icons.Gear/></button>}
                        <div className="w-px h-10 bg-gray-700 mx-2"></div>
                        <button onClick={onClose} className="px-5 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-bold text-sm">ë‚˜ê°€ê¸°</button>
                    </div>
                </div>
            );
        };

        const DashboardView = ({ user, studyPlan, selectedHours, setStep, isCamStudyOpen, setIsCamStudyOpen, isAdmin }) => {
            const activePlans = studyPlan.filter(p => p.content.trim() !== '');
            if (isCamStudyOpen) return <CamStudyView user={user} onClose={() => setIsCamStudyOpen(false)} isAdmin={isAdmin} />;
            return (
                <div className="max-w-6xl mx-auto py-8 px-4 fade-in">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-6 flex flex-col md:flex-row justify-between items-center">
                        <div className="mb-4 md:mb-0"><h2 className="text-2xl font-bold text-gray-900">ğŸš€ ë‚˜ë§Œì˜ í•™ìŠµ ê³„íší‘œ</h2><p className="text-gray-500 mt-1 text-sm">ì˜¤ëŠ˜ ì´ <span className="text-blue-600 font-bold text-lg mx-1">{selectedHours.length}ì‹œê°„</span>ì˜ í•™ìŠµì´ ì˜ˆì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. {isAdmin && <span className="text-yellow-600 font-bold ml-2">(ê´€ë¦¬ì ëª¨ë“œ)</span>}</p></div>
                        <div className="flex gap-2"><button onClick={() => setIsCamStudyOpen(true)} className="flex items-center gap-2 px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-md hover:shadow-lg animate-pulse"><Icons.Camera /> ìº  ìŠ¤í„°ë”” ì…ì¥</button><button onClick={() => setStep('selecting')} className="text-sm bg-gray-50 text-gray-600 border border-gray-200 px-4 py-2 rounded-lg hover:bg-gray-100 transition">ì‹œê°„ ì¬ì„¤ì •</button><button onClick={() => setStep('details')} className="text-sm bg-blue-50 text-blue-600 border border-blue-100 px-4 py-2 rounded-lg hover:bg-blue-100 transition font-bold flex items-center gap-1"><Icons.Edit /> ë‚´ìš© ìˆ˜ì •</button></div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6"><div className="lg:col-span-4 space-y-6"><PomodoroTimer /><MusicPlayer /></div><div className="lg:col-span-8"><div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 min-h-[600px]"><h3 className="font-bold text-gray-800 mb-6 flex items-center gap-2 pb-4 border-b border-gray-100"><span>ğŸ“</span> ì˜¤ëŠ˜ì˜ í•™ìŠµ ìŠ¤ì¼€ì¤„</h3><div className="space-y-6">{activePlans.length === 0 ? (<div className="text-center py-20 text-gray-400 flex flex-col items-center"><div className="text-4xl mb-4">ğŸ“­</div><p className="mb-4">ì•„ì§ ì‘ì„±ëœ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</p><button onClick={() => setStep('details')} className="text-blue-500 underline hover:text-blue-700">ì§€ê¸ˆ ê³„íš ì„¸ìš°ê¸°</button></div>) : (activePlans.map((plan, index) => (<div key={plan.id} className="flex gap-4 group"><div className="w-16 text-right pt-3 font-bold text-gray-400 text-lg">{selectedHours[index % selectedHours.length] || selectedHours[0]}:00</div><div className={`flex-1 p-5 rounded-2xl text-white shadow-lg transition transform hover:-translate-y-1 hover:shadow-xl bg-gradient-to-r ${plan.color === 'purple' ? 'from-purple-500 to-indigo-500' : plan.color === 'pink' ? 'from-pink-500 to-rose-500' : plan.color === 'orange' ? 'from-orange-400 to-red-400' : 'from-blue-500 to-cyan-500'}`}><div className="flex justify-between items-start mb-3"><span className="font-bold text-xs bg-white/20 px-2 py-1 rounded backdrop-blur-sm border border-white/10">{plan.subject}</span></div><p className="text-lg font-medium leading-relaxed whitespace-pre-wrap">{plan.content}</p></div></div>)))}</div></div></div></div>
                </div>
            );
        };

        const Navbar = ({ user, handleLogout, setStep, handleManualSave, saveStatus, isAdmin }) => (
            <nav className="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-50">
                <div className="flex items-center gap-3"><div className="text-2xl font-bold text-gray-800 cursor-pointer" onClick={() => setStep('empty')}>RootEdu</div>{isAdmin && <span className="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-bold border border-yellow-200">ğŸ‘‘ ê´€ë¦¬ì</span>}</div>
                <div>{user ? (<div className="flex items-center gap-4"><button onClick={handleManualSave} disabled={saveStatus === 'saving'} className={`flex items-center gap-1 px-4 py-2 rounded-lg font-bold text-sm transition shadow-sm ${saveStatus === 'saved' ? 'bg-green-50 text-green-600 border border-green-200' : saveStatus === 'error' ? 'bg-red-50 text-red-600 border border-red-200' : 'bg-indigo-50 text-indigo-600 border border-indigo-200 hover:bg-indigo-100'}`}>{saveStatus === 'saving' ? <>â³ ì €ì¥ ì¤‘...</> : saveStatus === 'saved' ? <>âœ… ì €ì¥ë¨</> : <><Icons.Save /> ì €ì¥í•˜ê¸°</>}</button><div className="h-6 w-px bg-gray-200 mx-2"></div><span className="hidden md:inline text-gray-600 font-bold">{user.displayName || user.email}ë‹˜</span><button onClick={handleLogout} className="text-gray-500 hover:text-gray-900 text-sm">ë¡œê·¸ì•„ì›ƒ</button></div>) : null}</div>
            </nav>
        );

        function App() {
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [isLoadingData, setIsLoadingData] = useState(true); 
            const [saveStatus, setSaveStatus] = useState('idle');
            const [isCamStudyOpen, setIsCamStudyOpen] = useState(false);
            
            const [step, setStep] = useState('empty'); 
            const [selectedHours, setSelectedHours] = useState([19, 20, 21]); 
            const [currentEditingSubject, setCurrentEditingSubject] = useState('kor');
            const [studyPlan, setStudyPlan] = useState([{ id: 'kor', subject: 'êµ­ì–´', color: 'purple', content: '' }, { id: 'math', subject: 'ìˆ˜í•™', color: 'pink', content: '' }, { id: 'eng', subject: 'ì˜ì–´', color: 'orange', content: '' }, { id: 'sci', subject: 'íƒêµ¬', color: 'blue', content: '' }]);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        if (ADMIN_EMAILS.includes(currentUser.email)) setIsAdmin(true); else setIsAdmin(false);
                        try {
                            const doc = await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('data').doc('planner').get();
                            if (doc.exists) { const data = doc.data(); setStep(data.step || 'empty'); setSelectedHours(data.selectedHours || []); if (data.studyPlan) setStudyPlan(data.studyPlan); }
                        } catch (err) { console.error(err); } finally { setIsLoadingData(false); }
                    } else { setUser(null); setIsAdmin(false); setStep('empty'); setIsLoadingData(false); }
                });
                return () => unsubscribe();
            }, []);

            const handleManualSave = async () => {
                if (!user) return; setSaveStatus('saving');
                try { await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('data').doc('planner').set({ step, selectedHours, studyPlan, lastUpdated: new Date() }, { merge: true }); setSaveStatus('saved'); setTimeout(() => setSaveStatus('idle'), 3000); } catch (err) { setSaveStatus('error'); setTimeout(() => setSaveStatus('idle'), 3000); }
            };

            const handleLogout = () => { auth.signOut(); };

            if (!user) return <AuthView setIsLoggedIn={() => {}} />;
            if (isLoadingData) return <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50"><div className="loader mb-4"></div><p className="text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p></div>;

            return (
                <div className="min-h-screen pb-10">
                    <Navbar user={user} handleLogout={handleLogout} setStep={setStep} handleManualSave={handleManualSave} saveStatus={saveStatus} isAdmin={isAdmin} />
                    {step === 'empty' && <EmptyPlanView setStep={setStep} />}
                    {step === 'selecting' && <TimeSelectionView selectedHours={selectedHours} setSelectedHours={setSelectedHours} setStep={setStep} />}
                    {step === 'details' && <DetailInputView studyPlan={studyPlan} setStudyPlan={setStudyPlan} setStep={setStep} currentEditingSubject={currentEditingSubject} setCurrentEditingSubject={setCurrentEditingSubject} />}
                    {step === 'dashboard' && <DashboardView user={user} studyPlan={studyPlan} selectedHours={selectedHours} setStep={setStep} isCamStudyOpen={isCamStudyOpen} setIsCamStudyOpen={setIsCamStudyOpen} isAdmin={isAdmin} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

